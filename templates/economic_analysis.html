<head>
    <style>
        .scrollable-container {
            max-height: 400px; /* Adjust this value as needed */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #ddd; /* Optional border */
            padding: 10px;
            width: 20%; /* Full width */
            position: relative;
        }

        .item-box {
            border: 1px solid #e3e3e3;
            padding: 1rem;
            width: 100%; /* Full width of the container */
            cursor: pointer;
            margin-bottom: 10px; /* Add some spacing between items */
        }

        .sortable-selected {
            background-color: #e3e3e3;
            border: 1px solid #000;
        }

        /* 固定 h3 標題 */
        .scrollable-container h3 {
            position: sticky;
            top: 0;
            background-color: #ddd;
            z-index: 1;
            padding: 5px;
            margin: 0;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>經濟分析</h1>
    <h2>各國經濟總覽</h2>
        <form method="post" action="{{ url_for('update_data5') }}" id="updateForm">
            <input type="hidden" name="updated_item" id="updated_item">
            <p>
                <button type="button" onclick="submitFormWithUpdatedItem('all')">更新資料</button>
            </p>
        </form>

        <div style="display: flex; justify-content: space-between;">
            <div class="scrollable-container" id="sortable1">
                <h3>國家</h3>
                {% for df5_label in df5_labels %}
                <div class="item-box" 
                    data-value="{{ df5[df5_label] | safe }}" 
                    data-key="{{ df5[df5_label].keys() | list }}"
                    name="selection_query" 
                    value="{{ df5_label | safe }}" 
                    onclick="transferItem(this)">
                        {{ df5_label | safe }}
                </div>
                {% endfor %}
            </div>

            <div class="scrollable-container" id="sortable2">
                <h3>欄位</h3>
                <!-- Items from sortable1 will appear here -->
            </div>

            <div style="width:70%">
                <canvas id="selectionChart"></canvas>
            </div>
        </div>
    <h2>各國Swift占比</h2>
        <form method='post' action={{ url_for('update_data12') }}>
            <p>
            <button type='submit'>更新資料</button>
            </p>
        </form>

        <div style="width:70%">
            <canvas id="myChart3"></canvas>
        </div>
    
    <h2>各國經濟數據</h2>
        <form method='post' action={{ url_for('update_data13') }}>
            <p>
            <button type='submit'>更新資料</button>
            </p>
        </form>
        <div style="display: flex; justify-content: space-between;">
            <div class="scrollable-container" id="sortable3">
                <h3>商品類別</h3>
                {% for df13_label in df13_labels %}
                <div class="item-box" 
                    data-value="{{ df13[df13_label] | safe }}" 
                    data-key="{{ df13[df13_label].keys() | list }}"
                    name="selection_query" 
                    value="{{ df13_label | safe }}" 
                    onclick="transferItemSortable3(this)">
                    {{ df13_label | safe }}
                </div>
                {% endfor %}
            </div>
    
            <div class="scrollable-container" id="sortable4">
                <h3>欄位</h3>
                <!-- Items from sortable3 will appear here -->
            </div>
    
            <div style="width:70%">
                <canvas id="selectionChart2"></canvas>
            </div>
        </div>

    <h2>中國汽車銷量</h2>
    <form method='post' action={{ url_for('update_data14') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>
    <div style="height:90%;width:90%;">
        <canvas id="dualYAxisChart"></canvas>
    </div>
    

</body>

<!-- 各國經濟總覽 -->
<script>

    const selectedItems = [];

    function transferItem(item) {
        const sortable2 = document.getElementById('sortable2');
        // console.log(sortable2)
        let keys = item.getAttribute('data-key');
        keys = keys.replace(/'/g, '"');

        try {
            keys = JSON.parse(keys);
        } catch (e) {
            keys = keys.split(',');
        }

        const label = item.getAttribute('value');
        const data = item.getAttribute('data-value');
        
        const existingIndex = selectedItems.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));

        if (existingIndex > -1) {
            item.classList.remove('sortable-selected');
            selectedItems.splice(existingIndex, 1);
            removeFieldsFromSortable2(label);
        } else {
            item.classList.add('sortable-selected');
            selectedItems.push({ label, data });
            addFieldsToSortable2(keys, label);
        }
        
    }

    function addFieldsToSortable2(keys, label) {
        const sortable2 = document.getElementById('sortable2');
        const df5 = {{df5|safe}}
        
        keys.forEach(key => {
            if (!key.includes('unit') && !key.includes('date')) {
                const keyItem = document.createElement('div');
                keyItem.className = 'item-box';
                keyItem.textContent = `${label} - ${key}`;
                keyItem.dataset.key = key;
                keyItem.dataset.label = label;
                keyItem.dataset.value = JSON.stringify(df5[label][key])
                keyItem.dataset.textContent = JSON.stringify(df5[label][`${key}_date`])

                // 直接為動態新增的元素綁定點擊事件
                keyItem.addEventListener('click', () => {
                    const data = JSON.parse(keyItem.getAttribute('data-value'));
                    const itemLabel = `${label} - ${key}`;
                    
                    // 查找是否已經選中
                    const existingIndex = selectedItems2.findIndex(selected => selected.label === itemLabel && JSON.stringify(selected.data) === JSON.stringify(data));
                    
                    if (existingIndex > -1) {
                        keyItem.classList.remove('sortable-selected');
                        selectedItems2.splice(existingIndex, 1);
                    } else {
                        keyItem.classList.add('sortable-selected');
                        selectedItems2.push({ label: itemLabel, data, textContent: keyItem.dataset.textContent });
                    }
                    // console.log(selectedItems2)
                    
                    // 更新圖表
                    updateChart(selectedItems2);
                });
                sortable2.appendChild(keyItem);
            }
        });
    }

    function removeFieldsFromSortable2(label) {
    const sortable2 = document.getElementById('sortable2');
    const itemsToRemove = sortable2.querySelectorAll(`.item-box[data-label='${label}']`);

    itemsToRemove.forEach(item => {
        // 查找並從 selectedItems2 中移除項目
        const existingIndex = selectedItems2.findIndex(selected => selected.label === `${label} - ${item.dataset.key}`);
        if (existingIndex > -1) {
            selectedItems2.splice(existingIndex, 1);
        }
        sortable2.removeChild(item);
    });
    
    // 更新圖表
    updateChart(selectedItems2);
    }
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const selectedItems2 = [];
        const itemBoxes = document.querySelectorAll('#sortable2 .item-box');
        itemBoxes.forEach(item => {
        item.addEventListener('click', () => {
            // 解析 data-value 屬性的 JSON 數據
            const data = item.getAttribute('data-value');
            const label = item.getAttribute('value');
            // 查找是否已經選中
            const existingIndex = selectedItems2.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));

            if (existingIndex > -1) {
                // 如果已選中，則取消選中
                item.classList.remove('sortable-selected');
                selectedItems2.splice(existingIndex, 1);
            } else {
                // 如果未選中，則添加到選中項目中
                item.classList.add('sortable-selected');
                selectedItems2.push({ label, data });
            }

            // 更新圖表
            updateChart(selectedItems2);
         });
      });

        const sc = document.getElementById('selectionChart').getContext('2d');
        let selectionChart = new Chart(sc, {
            type: 'line',
            data: {
                labels: [], // Example labels
                datasets: []
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });




    function updateChart(selectedData) {
        // Step 1: Collect all unique timestamps from selectedData
        const uniqueLabels = new Set();
        selectedData.forEach(item => {
            let itemLabels;
            try {
                itemLabels = JSON.parse(item.textContent);
                itemLabels.forEach(label => uniqueLabels.add(label));
            } catch (e) {
                console.error("Error parsing textContent for labels:", e);
            }
        });

        // Convert Set to sorted array of unique labels (timestamps)
        const sortedLabels = Array.from(uniqueLabels)
            .sort((a, b) => new Date(a) - new Date(b)); // Sort by date

        // Step 2: Prepare datasets with data aligned to sortedLabels
        const datasets = selectedData.map(item => {
            let itemLabels, itemData;

            try {
                itemLabels = JSON.parse(item.textContent);
                itemData = item.data;
            } catch (e) {
                console.error("Error parsing item data or labels:", e);
            }

            // Align data with sortedLabels by placing nulls where timestamps don't match
            const alignedData = sortedLabels.map(label => {
                const index = itemLabels ? itemLabels.indexOf(label) : -1;
                return index !== -1 ? itemData[index] : null;
            });

            return {
                label: item.label,
                data: alignedData,
                fill: false,
                borderColor: getRandomColor(),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            };
        });

        // Step 3: Update chart with sorted labels and aligned datasets
        selectionChart.data.labels = sortedLabels;  // Set x-axis to all unique timestamps
        selectionChart.data.datasets = datasets;
        selectionChart.update();
    }




            // Function to generate random colors for the chart lines
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function submitFormWithUpdatedItem(value) {
                document.getElementById('updated_item').value = value;
                document.getElementById('updateForm').submit();
            }
        </script>

<!-- 各國Swift占比 -->
 <script>
    let ctx = document.getElementById("myChart3");
    let df12 = {{ df12 | tojson }};
    let currencyLabels = {{ df12_labels | tojson }};

    console.log(currencyLabels)

    // Extract unique time labels from df12 data
    let timeLabelsSet = new Set();
    currencyLabels.forEach(label => {
        df12[label]["時間"].forEach(time => timeLabelsSet.add(time));
    });
    let timeLabels = Array.from(timeLabelsSet).sort();  // Convert set to sorted array

    // Prepare datasets for each currency with percentages aligned to timeLabels
    let datasets = currencyLabels.map(label => {
        let data = timeLabels.map(time => {
            let timeIndex = df12[label]["時間"].indexOf(time);
            return timeIndex !== -1 ? parseFloat(df12[label]["SWIFT占比"][timeIndex].replace("%", "")) : 0;
        });
        return {
            label: label,
            data: data,
            borderWidth: 1,
            // Optional: Specify backgroundColor dynamically if needed
        };
    });

    let myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: timeLabels,
            datasets: datasets
        },
        options: {
            scales: {
                x: {
                    stacked: true,
                },
                y: {
                    beginAtZero: true,
                    stacked: true,
                }
            }
        }
    });
</script>

<!-- 各國經濟數據 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const selectedItems3 = [];
    const selectedItems4 = [];
    let selectionChart2;

    function transferItemSortable3(item) {
        const sortable4 = document.getElementById('sortable4');
        let keys = item.getAttribute('data-key').replace(/'/g, '"');
        keys = JSON.parse(keys);
        const label = item.getAttribute('value');
        const data = item.getAttribute('data-value');

        const existingIndex = selectedItems3.findIndex(selected => selected.label === label && selected.data === data);

        if (existingIndex > -1) {
            item.classList.remove('sortable-selected');
            selectedItems3.splice(existingIndex, 1);
            removeFieldsFromSortable4(label);
        } else {
            item.classList.add('sortable-selected');
            selectedItems3.push({ label, data });
            addFieldsToSortable4(keys, label);
        }
    }

    function addFieldsToSortable4(keys, label) {
        const sortable4 = document.getElementById('sortable4');
        const df13 = {{ df13 | safe }};
        
        keys.forEach(key => {
            if (!key.includes('unit') && !key.includes('date')) {
                const keyItem = document.createElement('div');
                keyItem.className = 'item-box';
                keyItem.textContent = `${label} - ${key}`;
                keyItem.dataset.key = key;
                keyItem.dataset.label = label;
                keyItem.dataset.value = JSON.stringify(df13[label][key]);

                keyItem.addEventListener('click', () => {
                    const data = JSON.parse(keyItem.dataset.value);
                    const itemLabel = `${label} - ${key}`;
                    const existingIndex = selectedItems4.findIndex(selected => selected.label === itemLabel && JSON.stringify(selected.data) === JSON.stringify(data));

                    if (existingIndex > -1) {
                        keyItem.classList.remove('sortable-selected');
                        selectedItems4.splice(existingIndex, 1);
                    } else {
                        keyItem.classList.add('sortable-selected');
                        selectedItems4.push({ label: itemLabel, data });
                    }
                    
                    updateChart2(selectedItems4);
                });
                sortable4.appendChild(keyItem);
            }
        });
    }

    function removeFieldsFromSortable4(label) {
        const sortable4 = document.getElementById('sortable4');
        const itemsToRemove = sortable4.querySelectorAll(`.item-box[data-label='${label}']`);

        itemsToRemove.forEach(item => {
            // Remove the item from the DOM
            sortable4.removeChild(item);

            // Find and remove the item from selectedItems4
            const existingIndex = selectedItems4.findIndex(
                selected => selected.label === `${label} - ${item.dataset.key}`
            );
            if (existingIndex > -1) {
                selectedItems4.splice(existingIndex, 1);
            }
        });

        // Update the chart with the updated selectedItems4
        updateChart2(selectedItems4);
    }


    function updateChart2(selectedData) {
        // Ensure a unified set of date-time labels across all datasets
        const allLabels = new Set();
        selectedData.forEach(item => {
            item.data['Date'].forEach((date, i) => {
                const dateTime = `${date} ${item.data['time'][i]}`;
                allLabels.add(dateTime);
            });
        });
        const labels = Array.from(allLabels).sort(); // Sort labels chronologically

        // Map each dataset to the unified x-axis labels
        const datasets = selectedData.map(item => {
            const valueKey = item.data['Price'] ? 'Price' : 'Yield';

            const dataMap = new Map();
            item.data['Date'].forEach((date, i) => {
                const dateTime = `${date} ${item.data['time'][i]}`;
                dataMap.set(dateTime, item.data[valueKey][i]);
            });
            
            // Fill data array based on the unified labels (null if no data for the date-time)
            const data = labels.map(label => dataMap.has(label) ? dataMap.get(label) : null);

            return {
                label: item.label,
                data: data,
                fill: false,
                borderColor: getRandomColor(),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            };
        });

        // Destroy previous chart instance if it exists
        if (selectionChart2) selectionChart2.destroy();

        // Create new chart instance with unified x-axis
        const ctx = document.getElementById('selectionChart2').getContext('2d');
        selectionChart2 = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Date and Time' } },
                    y: { beginAtZero: true }
                }
            }
        });
}

    function getRandomColor() {
        return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
    }
</script>

<!-- 中國汽車銷量 -->
<!-- <script>
    console.log({{df14 | safe}})
    const df14 = {{df14 | safe}}
    const indexs_14 = {{df14['中國汽車銷量']['时间'] | safe}}
    const label_14 = Object.keys(df14['中國汽車銷量']).slice(1)
    console.log(label_14)
    const data14 = {{df14['中國汽車銷量'] | safe}}

    const cc = document.getElementById('chartContainer').getContext('2d');
    
    // Prepare datasets for each country
    const datasets14 = label_14.map(country => ({
        label: country,
        data: data14[country],
        fill: false,
        borderColor: getRandomColor(),
        tension: 0.1
    }));

    console.log(datasets14)

    // Function to generate random colors for each line
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // Create the chart
    new Chart(cc, {
        type: 'line',
        data: {
            labels: indexs_14, // X-axis (e.g., time periods)
            datasets: datasets14
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time Period'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            }
        }
    });
</script> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dual Y-Axis Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <canvas id="dualYAxisChart" width="800" height="400"></canvas>
    <script>
        console.log({{df14 | safe}})
        const df14 = {{df14 | safe}}
        const indexs_14 = {{df14['中國汽車銷量']['时间'] | safe}}
        const label_14 = Object.keys(df14['中國汽車銷量']).slice(1)
        console.log(label_14)
        const data14 = {{df14['中國汽車銷量'] | safe}}
        const cc = document.getElementById('dualYAxisChart').getContext('2d');

        // Assuming data1 and data2 are arrays representing your data for the two y-axes
        const labels = indexs_14;  // Replace with your actual labels
        const data1 = data14['销量'];  // Replace with data for the first dataset
        const data2 = data14['同比'];           // Replace with data for the second dataset

        const dualYAxisChart = new Chart(cc, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Sales Volume',
                        data: data1,
                        yAxisID: 'y',
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Growth Rate',
                        data: data2,
                        yAxisID: 'y1',
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Sales Volume'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Growth Rate'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
