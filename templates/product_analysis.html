
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>產品分析</title>
    <style>
        .table-container {
            width: 100%; /* Set a width for the container */
            max-height: 400px; /* Fixed height */
            overflow-y: scroll; /* Vertical scrolling */
            overflow-x: auto; /* Horizontal scrolling if needed */
            border: 1px solid #ddd; /* Optional: border around the table container */
        }

        table.data {
            width: 100%;
            border-collapse: collapse; /* Ensure the borders are collapsed */
        }

        table.data th, table.data td {
            border: 1px solid #ddd; /* Border for the table */
            padding: 8px;
            text-align: left;
        }

        table.data th {
            background-color: #f2f2f2;
            position: sticky; /* Keep header row fixed during vertical scroll */
            top: 0;
        }
        table {
            display: block;
            max-height: 370px;
            overflow: auto;
        }

        .scrollable-container {
        max-height: 400px; /* Adjust this value as needed */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 1px solid #ddd; /* Optional border */
        padding: 10px;
        width: 20%; /* Full width */
        }


        .sortable-selected {
            background-color: #e3e3e3;
            border: 1px solid #000;
        }
        
        /* 設置按鈕容器為 Flex 容器，橫向排列 */
        .button-container {
            display: flex;
            flex-direction: column; /* 預設值，可省略 */
            gap: 10px; /* 按鈕之間的間距 */
            /* 可選擇添加下列屬性來調整對齊方式 */
            /* justify-content: flex-start; */
            /* align-items: center; */
            /* 若按鈕數量過多，可允許換行 */
            flex-wrap: wrap;
        }
        
        /* 整合後的 .item-box 樣式 */
        .item-box {
        border: 1px solid #e3e3e3;
        padding: 1rem;
        width: 100%; /* Full width of the container */
        cursor: pointer;
        margin-bottom: 10px; /* Add some spacing between items */
    }


        /* Additional styling if needed */
        .btn-secondary {
            background-color: #66B3FF;
            color: white;
        }

        /* 新增選中項目的樣式 */
        .selected-field {
            background-color: #007BFF; /* 藍色背景 */
            color: #FFFFFF; /* 白色文字 */
            border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        .selected-country {
        background-color: #007BFF; /* 藍色背景 */
        color: #FFFFFF; /* 白色文字 */
        border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        .selected-item {
            background-color: #007BFF; /* 藍色背景 */
            color: #FFFFFF; /* 白色文字 */
            border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        /* 標題固定樣式 */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #f2f2f2; /* 淺灰色背景 */
            padding: 10px;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            z-index: 1; /* 保持在列表內容上層 */
        }
        
        /* 按鈕樣式 */
        button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f0f0f0;
            color: #000;
        }

        /* 選取狀態樣式 */
        button.selected {
            background-color: #66B3FF; /* 綠色背景表示已選取 */
            color: #fff; /* 白色文字 */
        }

        #table-of-contents {
            background-color: #f9f9f9; /* 目錄背景顏色，淺灰色 */
            padding: 20px; /* 內距 */
            border: 1px solid #ddd; /* 邊框 */
            border-radius: 5px; /* 邊框圓角 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 添加陰影效果 */
        }

        #table-of-contents h2 {
            color: #333; /* 標題文字顏色 */
            font-weight: bold; /* 標題加粗 */
        }

        #table-of-contents ul {
            padding-left: 20px; /* 列表內距 */
            list-style-type: disc; /* 使用實心圓點樣式 */
        }

        #table-of-contents li {
            margin-bottom: 10px; /* 列表項目間距 */
        }

        #table-of-contents a {
            text-decoration: none; /* 移除超連結的底線 */
            color: #007BFF; /* 超連結文字顏色 */
        }

        #table-of-contents a:hover {
            text-decoration: underline; /* 滑鼠懸停時添加底線 */
            color: #0056b3; /* 改變超連結顏色 */
        }
        .formula {
            text-align: left;
            margin: 0 auto;
            padding-left: 10px;
        }
        .math-block {
            margin: 0px 0;
            padding-left: 0px; /* 適當控制公式的縮進 */
        }


    </style>
</head>

<body>
    <div id="table-of-contents">
        <h2>目錄</h2>
        <ul>
            <li><a href="#import-export-data">進出口資料</a></li>
            <li><a href="#search-volume">各國產品搜索量</a></li>
            <li><a href="#industrial-growth">工業生產增加率</a></li>
            <li><a href="#gov-projects">政府推動計畫名單</a></li>
            <li><a href="#economic-overview">各國經濟總覽</a></li>
            <li><a href="#shipping-data">航運數據</a></li>
            <li><a href="#word-cloud">文字雲</a></li>
            <li><a href="#metal-market">金屬市場數據分析</a></li>
        </ul>
    </div>

    <h2 id="import-export-data">進出口資料</h2>
    
    <form method='post' action={{ url_for('update_data1') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <!-- 左邊的長條圖 -->
        <div style="width: 50%;">
            <h3>可互換之搪孔或拉孔工具，工具機用</h3>
            <canvas id="myChart"></canvas>
        </div>

        <!-- 右邊的圓餅圖 -->
        <div style="width: 40%;">
            <h3>公司佔台灣出口佔比</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>  
    
    <h2 id="search-volume">各國產品搜索量</h2>
    <p>指在特定時間範圍內，某國家/地區內通過 Google 搜索相關字詞的流量數據。此數據採用相對指數的形式，以下是詳細說明：</p>
    <h3>1. 指數範圍</h3>
    <ul>
        <li><strong>100</strong> 代表該時間範圍內的搜索流量達到最高峰值（最大值）。</li>
        <li><strong>0</strong> 表示該時段幾乎沒有相關的搜索流量。</li>
    </ul>
    <h3>2. 時間比較</h3>
    <p>若在一段時間內搜索量持續保持 <strong>100</strong>，則表示該段期間的搜索流量大於或等於此前所有時間的最大搜索量。</p>
    <h3>3. 數據解讀</h3>
    <ul>
        <li><strong>持續達到 100</strong>：表明此產品或相關字詞的熱度顯著提升，可能有趨勢性的關注增長。</li>
        <li><strong>波動數據</strong>：則反映用戶的關注程度隨時間的變化情況。</li>
    </ul>
    <p>此方法適用於觀察產品或關鍵字的市場趨勢與受歡迎程度，對制定市場策略和了解用戶行為有重要參考價值。</p>
    <form method="post" action="{{ url_for('update_data2') }}" id="productVolumeForm">
        <input type="hidden" name="updated_item" id="productUpdatedItem">
        <p>
            <button type="button" onclick="submitProductVolumeUpdate('ProductVolume')">更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <!-- 左側：國家列表 -->
        <div class="scrollable-container" id="productCountryList">
            <h3>國家</h3>
            {% for df2_label in df2_labels %}
            <div class="item-box"
                data-value="{{ df2[df2_label] | safe }}"
                data-key="{{ df2[df2_label].keys() | list }}"
                value="{{ df2_label | safe }}"
                onclick="selectProductCountry(this)">
                {{ df2_label | safe }}
            </div>
            {% endfor %}
        </div>

        <!-- 中間：欄位列表 -->
        <div class="scrollable-container" id="productFieldList">
            <h3>欄位</h3>
        </div>

        <!-- 右側：折線圖 -->
        <div style="width: 70%;">
            <canvas id="productVolumeChart"></canvas>
        </div>
    </div>

    <script id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <h2 id="industrial-growth">工業生產增指數年增率</h2>
    <form method='post' action={{ url_for('update_data3') }}>
        <p>
        <button type='submit'>更新資料</button>
    </p>
    </form>
    <body>
        <p>工業生產指數採用<strong>拉氏公式 (Laspeyres Formula)</strong> 計算，主要用於衡量工業部門產品生產量在某一時間與基期之間的相對變動情況。</p>
        
        <h3>1.  工業生產指數定義</h3>
        <p>工業生產指數是一項反映工業部門生產活動變化的指標。根據 109 年工廠校正及營運調查結果，各項產品的權數是基於以市價計算的生產毛值占工業總生產毛值的比重。</p>
    
        <h3>2.  計算公式</h3>
        <div class="formula">
            <p>指數計算公式：</p>
            <div class="math-block">
                \[
                I_{n,1} = L_{2,1} \times L_{3,2} \times \cdots \times L_{n,n-1} \times 100 = \prod_{k=1}^{n-1} L_{k+1,k} \times 100
                \]
            </div>
            <p>其中：</p>
            <div class="math-block">
                \[
                L_{t+1,t} = \frac{\sum Q_{i,t+1} \cdot P_{i,t}}{\sum Q_{i,t} \cdot P_{i,t}}
                \]
            </div>
            <p>符號說明：</p>
            <ul>
                <li>\( Q_{i,t} \)：第 \( t \) 期的生產量</li>
                <li>\( Q_{i,t+1} \)：第 \( t+1 \) 期的生產量</li>
                <li>\( P_{i,t} \)：第 \( t \) 期的附加價值單價</li>
            </ul>
        </div>
    
        <h3>3. 權數計算</h3>
        <p>各項產品的市價計算之生產毛值計算如下：</p>
        <p><strong>以市價計算之生產毛值</strong> ＝ 生產價值 － (原材物燃料耗用值 ＋ 電力費用 ＋ 其他費用)</p>
    </body>
    <div style="height:90%;width:90%;">
        <canvas id="chartContainer"></canvas>
    </div> 

    <h2 id="gov-projects">政府推動計畫名單</h2>
    <h3>1. 主題式研發</h3>
    <P>為因應產業需求及政策發展方向，急需整合產業相關業者進行研發，由經濟部產業發展署不定期公告研發主題，公開徵求廠商提案，鼓勵業者開發符合主題研發內容之技術、產品或服務，以串連產業鏈發展為主軸，建立產業研發能量，帶動相關產業健全發展及強化整體產業競爭力。</P>
    <h3>2. 新興育成</h3>
    <P>因應產業需求及政策發展方向，發展替代性的主流新興產業，鼓勵業者進行開發新興產品或服務，進而構築產業生態體系，經濟部推動「產業升級創新平台輔導計畫」， 並依據「經濟部協助產業創新活動補助獎勵及輔導辦法」（以下簡稱本辦法），訂定「產業升級創新平台輔導計畫申請須知(新興育成計畫)」（以下簡稱本須知），以補助方式協助廠商自行或異業結合， 或運用學研前瞻科研成果，發展新興產業之產品或服務。</P>
    <h3>3. 創新優化</h3>
    <P>為鼓勵具指標性廠商掌握關鍵技術/產品，以建構完整供應鏈體系，或引導業者建立整體系統解決方案供應者能量，以擴大整廠整案海外輸出，爭取國際商機，經濟部推動「產業升級創新平台輔導計畫」，並依據「經濟部協助產業創新活動補助獎勵及輔導辦法」（以下簡稱本辦法），訂定「產業升級創新平台輔導計畫申請須知(創新優化計畫)」（以下簡稱本須知），以補助方式協助廠商開發關鍵設備、材料及零組件，提供跨領域系統整合，發展整體解決方案。</P>
    <h3>4. 產業高值</h3>
    <P>為引導產業朝向高值化發展，鼓勵業者切入高端產品應用市場，以提升整體產業附加價值率，塑造我國高值化產品形象，經濟部推動「產業升級創新平台輔導計畫」，並依據「經濟部協助產業創新活動補助獎勵及輔導辦法」（以下簡稱本辦法），訂定「產業升級創新平台輔導計畫申請須知(產業高值計畫)」（以下簡稱本須知），以補助方式協助廠商藉由高值化研發掌握價值鏈之關鍵技術，或開發創新的服務加值模式，切入高端產品應用市場，創造產品單價(毛利)或銷售量倍數成長之商品價值。</P>

    <form method='post' action={{ url_for('update_data4') }}>
        <p>
        <button type='submit'>更新資料</button>
    </p>
    </form>
    <input type="text" id="searchInput" placeholder="Search for keywords">
    <div>
        {% for table in tables %}
        {{ table|safe }}
        {% endfor %}
    </div>

    <h2 id="economic-overview">各國經濟總覽</h2>
    <P>收錄關於公司外銷國家的主要經濟數據</P>
    <form method="post" action="{{ url_for('update_data5') }}" id="updateForm">
        <!-- Hidden input to store updated_item -->
        <input type="hidden" name="updated_item" id="updated_item">
    
        <p>
            <!-- Button that triggers JavaScript to set the updated_item value -->
            <button type="button" onclick="submitFormWithUpdatedItem('Overview')">更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <div class="scrollable-container" id="sortable1">
            <h3>國家</h3>
            {% for df5_label in df5_labels %}
            <div class="item-box" 
                 data-value="{{ df5[df5_label] | safe }}" 
                 data-key="{{ df5[df5_label].keys() | list }}"
                 name="selection_query" 
                 value="{{ df5_label | safe }}" 
                 onclick="transferItem(this)">
                    {{ df5_label | safe }}
            </div>
            {% endfor %}
        </div>

        <div class="scrollable-container" id="sortable2">
            <h3>欄位</h3>
            <!-- Items from sortable1 will appear here -->
        </div>

        <div style="width:70%">
            <canvas id="selectionChart"></canvas>
        </div>
        
    </div>

    <h2 id="shipping-data">航運數據</h2>
    <form method='post' action={{ url_for('update_data7') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>
    <div class="btn-group" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線綜合準班率指數"}'>全球主幹航線綜合準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線到離港準班率指數"}'>全球主幹航線到離港準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線收發貨準班率指數"}'>全球主幹航線收發貨準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:準班率"}'>港口班輪準確率:準班率</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:掛靠數"}'>港口班輪準確率:掛靠數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:班期综合服务水平"}'>港口班輪準確率:班期综合服务水平</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在港时间(天)"}'>港口班輪準確率:在港时间(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在泊時間(天)"}'>港口班輪準確率:在泊時間(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路航貿指數"}'>一帶一路航貿指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路貿易額指數"}'>一帶一路貿易額指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "集裝箱海運量指數"}'>集裝箱海運量指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "海上絲綢之路運價指數"}'>海上絲綢之路運價指數</button>
    </div>
    
    <!-- 使用 Flexbox 布局实现左右并排 -->
    <div style="display: flex; width: 100%; margin-top: 20px;">
        <div style="width: 70%;">
            <canvas id="shipping_chart"></canvas>
        </div>

        <div style="width: 30%;" id="description">
            <p>請選擇一個指數以顯示詳細解說。</p>
        </div>
    </div>

    <h2 id="word-cloud">文字雲</h2>
    <form method='post' action="{{ url_for('update_data8') }}">
        <P>透過蒐集 Reddit 上關於 Syntec、Siemens 和 Fanuc 的相關評論，可以深入了解潛在客戶的痛點和商機。</P>
        <p>
            <label for="query">Enter Query:</label>
            <input type="text" name="query" id="query">
        </p>
        <p>
            <button type='submit'>更新資料</button>
        </p>
    </form>
    
    <div class="btn-group" role="group" aria-label="Company Selection">
        <button type="button" class="btn btn-primary" onclick="setCompany('fanuc', this)">Fanuc</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('siemens', this)">Siemens</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('syntec', this)">Syntec</button>
    </div>
    
    <div class="btn-group" role="group" aria-label="Index Selection">
        <button type="button" class="btn btn-primary" onclick="setIndex('title', this)">Title</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('subtitle', this)">Subtitle</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('content', this)">Content</button>
    </div>
    
    <!-- Initially hidden image element -->
    <img id="dynamicImage" style="display: none;" alt="文字雲">
    <h2 id="metal-market">金屬市場數據分析</h2>
    <h3>LME金屬價格波動對工具機市場的影響</h3>
    <p>倫敦金屬交易所（LME）的金屬價格波動對工具機市場有直接影響，因為金屬是工具機製造的主要原材料。</p>
    
    <h4>金屬價格對工具機市場的影響</h4>
    
    <strong><h5>1. 生產成本</h5></strong>
    <ul>
        <li><strong>原材料成本增加：</strong>金屬價格上漲會直接增加工具機製造所需材料的採購成本，例如鋼鐵、鋁和銅等常用材料。</li>
        <li><strong>影響：</strong>製造商可能需要提高產品售價以轉嫁成本，進而影響產品的市場競爭力。</li>
        <li><strong>應對措施：</strong>製造商可能尋求替代材料或優化設計以減少金屬用量。</li>
    </ul>
    
    <strong><h5>2. 市場需求波動</h5></strong>
    <ul>
        <li><strong>下游行業的敏感性：</strong>工具機被廣泛應用於汽車、航空航天、能源和重工業等行業。這些行業對金屬價格的波動極為敏感，因為金屬成本通常占其生產成本的很大比例。</li>
        <li><strong>價格上漲影響：</strong>若金屬價格高企，這些行業可能推遲或縮減資本支出，進而降低對工具機的需求。</li>
        <li><strong>價格下降影響：</strong>相反，金屬價格下降則可能刺激這些行業增加投資，帶動工具機市場需求上升。</li>
    </ul>
    
    <strong><h5>3. 供應鏈管理的挑戰</h5></strong>
    <ul>
        <li><strong>成本預測與庫存管理：</strong>金屬價格的不穩定性給工具機製造商的供應鏈管理帶來挑戰，尤其是在長期訂單和項目中，金屬價格波動可能導致預算超支。</li>
        <li><strong>影響：</strong>生產計劃可能被迫調整，甚至可能因成本過高而取消或延遲訂單。</li>
        <li><strong>應對措施：</strong>製造商可能使用對沖策略（如期貨合約）來穩定成本，或者增加庫存以避免價格高漲時的原材料短缺。</li>
    </ul>
    
    <h4>總結</h4>
    <p>
        金屬價格的波動對工具機市場的影響是多方面的：
    </p>
    <ul>
        <li>從生產端來看，金屬價格上漲會增加工具機的製造成本，進而推升價格，影響競爭力。</li>
        <li>從需求端來看，價格波動會影響工具機的下游行業投資規模，直接影響市場需求。</li>
        <li>供應鏈管理方面，價格波動增加了企業在成本控制和計劃執行上的挑戰。</li>
    </ul>
    <p>
        工具機製造商需密切關注金屬價格走勢，靈活調整策略，才能在波動的市場環境中保持競爭優勢。
    </p>
    <form method='post' action={{ url_for('update_data9') }}>
        <p>
            <button type='submit'>更新資料</button>
        </p>
    </form>
    
    <h3>價格</h3>
    <div style="display: flex; justify-content: space-between;">
        <!-- 第一欄：金屬類型 -->
        <div class="scrollable-container" id="metalCategoryList">
            <h3 class="sticky-header">金屬類型</h3>
            <div id="metalCategoryContent"></div>
        </div>
    
        <!-- 第二欄：金屬名稱 -->
        <div class="scrollable-container" id="metalNameList">
            <h3 class="sticky-header">金屬名稱</h3>
            <div id="metalNameContent"></div>
        </div>
    
        <!-- 第三欄：數據類型 -->
        <div class="scrollable-container" id="metalDataTypeList">
            <h3 class="sticky-header">數據類型</h3>
            <div id="metalDataTypeContent"></div>
        </div>

        <!-- 第四欄：數據報價日期 -->
        <div class="scrollable-container" id="metalDateList">
            <h3 class="sticky-header">數據報價日期</h3>
            <div id="metalDateContent"></div>
        </div>


        <!-- 折線圖顯示區 -->
        <!-- x軸: 各個contract, y軸: bid, ask, price -->
        <div style="width: 100%">
            <canvas id="metalDataChart"></canvas>
        </div>
    </div>

    <h3>交易量</h3>
    <div style="display: flex; justify-content: space-between;">
        <!-- 第一欄：金屬類型 -->
        <div class="scrollable-container" id="metalCategoryList2">
            <h3 class="sticky-header">金屬類型</h3>
            <div id="metalCategoryContent2"></div>
        </div>

        <!-- 第二欄：金屬名稱 -->
        <div class="scrollable-container" id="metalNameList2">
            <h3 class="sticky-header">金屬名稱</h3>
            <div id="metalNameContent2"></div>
        </div>

        <!-- 第三欄：數據報價日期 -->
        <div class="scrollable-container" id="metalDateList2">
            <h3 class="sticky-header">數據報價日期</h3>
            <div id="metalDateContent2"></div>
        </div>

        <!-- 折線圖顯示區 -->
        <div style="width: 100%">
            <canvas id="metalVolumeChart"></canvas>
        </div>
    </div>
    <button id="backToTop" style="display:none; position:fixed; bottom:20px; right:20px; padding:10px 20px; font-size:14px; background-color:#007BFF; color:white; border:none; border-radius:5px; cursor:pointer;">
        Back to Top
    </button> 
    

    
    

    </div>


    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const indexs = {{indexs | safe}}
        const label_im = {{ label_im | safe }};  // Ensure the list is safe to use
        // const data_im_indexs = {{ data_im_indexs | safe }};  // Ensure the list is safe to use
        const data_im_values = {{ data_im_values | safe }};  // Ensure the list is safe to use
        const cleaned_data_im_values = data_im_values.map(val => (isNaN(val) ? 0 : val));

        const label_ex = {{ label_ex | safe }};  // Ensure the list is safe to use
        // const data_ex_indexs = {{ data_ex_indexs | safe }};  // Ensure the list is safe to use
        const data_ex_values = {{ data_ex_values | safe }};  // Ensure the list is safe to use

        const chartElement = document.getElementById('myChart');

        new Chart(chartElement, {
            data: {
                labels: indexs,
                datasets: [
                    {
                        type: 'line',
                        label: label_im,
                        data: cleaned_data_im_values,
                        yAxisID: 'y-axis-left',  // First Y-axis
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    },
                    {
                        type: 'line',
                        label: label_ex,
                        data: data_ex_values,
                        yAxisID: 'y-axis-right',  // Second Y-axis
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    }
                ]
            },
            options: {
                scales: {
                    'y-axis-left': {
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            beginAtZero: true
                        }
                    },
                    'y-axis-right': {
                        type: 'linear',
                        position: 'right',
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });
        
    </script>
    
    <script>
        const newchartElement = document.getElementById('pieChart');
        new Chart(newchartElement, {
        type: 'pie',
        data: {
            labels: [
            '伺服電機',
            '控制器',
            '其他'
            ],
            datasets: [{
            label: '營收百分比',
            data: [54, 42, 4], // 需要先把數字轉為百分比
            }]
        },
        options: {
            plugins: {
            tooltip: { // hover
                callbacks: {
                label: function(context) {
                    return ` ${context.parsed} %`; // 想顯示的內容
                }
                }
            }
            }
        }
        });
    </script>

    <!-- data2 -->
    <script>
        // 儲存已選擇的國家和欄位資料
        const selectedProductCountries = [];
        const selectedProductFields = [];

        // 選擇國家並顯示對應的欄位
        function selectProductCountry(item) {
            const fieldContainer = document.getElementById('productFieldList');
            let fieldKeys = item.getAttribute('data-key');
            fieldKeys = fieldKeys.replace(/'/g, '"');

            try {
                fieldKeys = JSON.parse(fieldKeys);
            } catch (error) {
                fieldKeys = fieldKeys.split(',');
            }

            const countryLabel = item.getAttribute('value');
            const countryData = item.getAttribute('data-value');
            const existingIndex = selectedProductCountries.findIndex(selected => selected.label === countryLabel && JSON.stringify(selected.data) === JSON.stringify(countryData));

            if (existingIndex > -1) {
                item.classList.remove('selected-country');
                selectedProductCountries.splice(existingIndex, 1);
                removeProductFields(countryLabel);
            } else {
                item.classList.add('selected-country');
                selectedProductCountries.push({ label: countryLabel, data: countryData });
                displayProductFields(fieldKeys, countryLabel);
            }
        }

        // 顯示對應欄位列表
        function displayProductFields(keys, countryLabel) {
            const fieldContainer = document.getElementById('productFieldList');
            const productData = {{ df2 | safe }};

            keys.forEach(key => {
                if (!key.includes('unit') && !key.includes('date')) {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'item-box';
                    fieldItem.textContent = `${countryLabel} - ${key}`;
                    fieldItem.dataset.key = key;
                    fieldItem.dataset.label = countryLabel;
                    fieldItem.dataset.value = JSON.stringify(productData[countryLabel][key]);
                    fieldItem.dataset.dates = JSON.stringify(productData[countryLabel][`${key}_date`]);

                    fieldItem.addEventListener('click', () => {
                        const fieldData = JSON.parse(fieldItem.getAttribute('data-value'));
                        const fieldLabel = `${countryLabel} - ${key}`;
                        const existingIndex = selectedProductFields.findIndex(field => field.label === fieldLabel && JSON.stringify(field.data) === JSON.stringify(fieldData));

                        if (existingIndex > -1) {
                            fieldItem.classList.remove('selected-field');
                            selectedProductFields.splice(existingIndex, 1);
                        } else {
                            fieldItem.classList.add('selected-field');
                            selectedProductFields.push({ label: fieldLabel, data: fieldData, dates: fieldItem.dataset.dates });
                        }

                        updateProductVolumeChart(selectedProductFields);
                    });

                    fieldContainer.appendChild(fieldItem);
                }
            });
        }

        // 移除欄位並更新圖表
        function removeProductFields(countryLabel) {
            const fieldContainer = document.getElementById('productFieldList');
            const fieldsToRemove = fieldContainer.querySelectorAll(`.item-box[data-label='${countryLabel}']`);

            fieldsToRemove.forEach(item => {
                const fieldLabel = `${countryLabel} - ${item.dataset.key}`;
                const existingIndex = selectedProductFields.findIndex(field => field.label === fieldLabel);
                if (existingIndex > -1) {
                    selectedProductFields.splice(existingIndex, 1);
                }
                fieldContainer.removeChild(item);
            });

            updateProductVolumeChart(selectedProductFields);
        }

        // 更新折線圖
        function updateProductVolumeChart(selectedFields) {
        const uniqueDates = new Set();
        selectedFields.forEach(field => {
            let fieldDates;
            try {
                fieldDates = JSON.parse(field.dates);
                fieldDates.forEach(date => uniqueDates.add(date));
            } catch (error) {
                console.error("Error parsing dates:", error);
            }
        });

        const sortedDates = Array.from(uniqueDates).sort((a, b) => new Date(a) - new Date(b));
        const datasets = selectedFields.map(field => {
            let fieldDates, fieldData;
            try {
                fieldDates = JSON.parse(field.dates);
                fieldData = field.data;
            } catch (error) {
                console.error("Error parsing field data:", error);
            }

            const alignedData = sortedDates.map(date => {
                const index = fieldDates ? fieldDates.indexOf(date) : -1;
                return index !== -1 ? fieldData[index] : null;
            });

            return {
                label: field.label,
                data: alignedData,
                fill: false,
                borderColor: getRandomColor(),
                tension: 0.1,
            };
        });

        // 如果圖表已經存在，則只更新資料，不銷毀圖表
        if (window.productVolumeChartInstance) {
            window.productVolumeChartInstance.data.labels = sortedDates;
            window.productVolumeChartInstance.data.datasets = datasets;
            window.productVolumeChartInstance.update(); // 只更新圖表
        } else {
            // 初始化圖表
            const chartContext = document.getElementById('productVolumeChart').getContext('2d');
            window.productVolumeChartInstance = new Chart(chartContext, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Search Volume',
                            },
                        },
                    },
                },
            });
        }
    }


        // 隨機顏色生成
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 提交更新表單
        function submitProductVolumeUpdate(value) {
            document.getElementById('productUpdatedItem').value = value;
            document.getElementById('productVolumeForm').submit();
        }

    </script>

    <!-- data3 -->
    <script>
        const indexs_3 = {{ indexs_3 | safe }};
        const label_3 = {{ label_3 | safe }};
        const data = {{ data | safe }};
        const ctx = document.getElementById('chartContainer').getContext('2d');

        // 隨機顏色生成函數
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 計算移動平均
        function calculateMovingAverage(dataArray, period = 5) {
            const movingAverage = [];
            for (let i = 0; i < dataArray.length; i++) {
                if (i < period - 1) {
                    movingAverage.push(null); // 前幾個數據點無法計算移動平均
                } else {
                    const sum = dataArray.slice(i - period + 1, i + 1).reduce((acc, val) => acc + val, 0);
                    movingAverage.push(sum / period);
                }
            }
            return movingAverage;
        }

        // 準備每個國家的 dataset，包括原始數據和移動平均
        const datasets = label_3.map((country) => {
            const originalData = data[country];
            const movingAverageData = calculateMovingAverage(originalData, 5); // 使用 5 天移動平均
            const color = getRandomColor(); // 為該國家生成隨機顏色

            return [
                {
                    label: `${country} (原始數據)`,
                    data: originalData,
                    fill: false,
                    borderColor: color,
                    tension: 0.1,
                    hidden: true
                },
                {
                    label: `${country} (5 天移動平均)`,
                    data: movingAverageData,
                    fill: false,
                    borderColor: color,
                    borderDash: [2, 2],
                    tension: 0.1,
                    hidden: true
                },
            ];
        }).flat(); // 使用 flat 展開多維數組

        // 繪製圖表
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: indexs_3,
                datasets: datasets,
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period',
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value',
                        },
                    },
                },
            },
        });

    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            $("#searchInput").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("table.data tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>

    <!-- data5 -->
    <script>

        const selectedItems = [];
    
        function transferItem(item) {
            const sortable2 = document.getElementById('sortable2');
            // console.log(sortable2)
            let keys = item.getAttribute('data-key');
            keys = keys.replace(/'/g, '"');
    
            try {
                keys = JSON.parse(keys);
            } catch (e) {
                keys = keys.split(',');
            }
    
            const label = item.getAttribute('value');
            const data = item.getAttribute('data-value');
            
            const existingIndex = selectedItems.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));
    
            if (existingIndex > -1) {
                item.classList.remove('sortable-selected');
                selectedItems.splice(existingIndex, 1);
                removeFieldsFromSortable2(label);
            } else {
                item.classList.add('sortable-selected');
                selectedItems.push({ label, data });
                addFieldsToSortable2(keys, label);
            }
            
        }
    
        function addFieldsToSortable2(keys, label) {
            const sortable2 = document.getElementById('sortable2');
            const df5 = {{df5|safe}}
            
            keys.forEach(key => {
                if (!key.includes('unit') && !key.includes('date')) {
                    const keyItem = document.createElement('div');
                    keyItem.className = 'item-box';
                    keyItem.textContent = `${label} - ${key}`;
                    keyItem.dataset.key = key;
                    keyItem.dataset.label = label;
                    keyItem.dataset.value = JSON.stringify(df5[label][key])
                    keyItem.dataset.textContent = JSON.stringify(df5[label][`${key}_date`])
    
                    // 直接為動態新增的元素綁定點擊事件
                    keyItem.addEventListener('click', () => {
                        const data = JSON.parse(keyItem.getAttribute('data-value'));
                        const itemLabel = `${label} - ${key}`;
                        
                        // 查找是否已經選中
                        const existingIndex = selectedItems2.findIndex(selected => selected.label === itemLabel && JSON.stringify(selected.data) === JSON.stringify(data));
                        
                        if (existingIndex > -1) {
                            keyItem.classList.remove('sortable-selected');
                            selectedItems2.splice(existingIndex, 1);
                        } else {
                            keyItem.classList.add('sortable-selected');
                            selectedItems2.push({ label: itemLabel, data, textContent: keyItem.dataset.textContent });
                        }
                        // console.log(selectedItems2)
                        
                        // 更新圖表
                        updateChart(selectedItems2);
                    });
                    sortable2.appendChild(keyItem);
                }
            });
        }
    
        function removeFieldsFromSortable2(label) {
        const sortable2 = document.getElementById('sortable2');
        const itemsToRemove = sortable2.querySelectorAll(`.item-box[data-label='${label}']`);
    
        itemsToRemove.forEach(item => {
            // 查找並從 selectedItems2 中移除項目
            const existingIndex = selectedItems2.findIndex(selected => selected.label === `${label} - ${item.dataset.key}`);
            if (existingIndex > -1) {
                selectedItems2.splice(existingIndex, 1);
            }
            sortable2.removeChild(item);
        });
        
        // 更新圖表
        updateChart(selectedItems2);
        }
            
        </script>
        
        
    
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const selectedItems2 = [];
            const itemBoxes = document.querySelectorAll('#sortable2 .item-box');
            itemBoxes.forEach(item => {
            item.addEventListener('click', () => {
                // 解析 data-value 屬性的 JSON 數據
                const data = item.getAttribute('data-value');
                const label = item.getAttribute('value');
                // 查找是否已經選中
                const existingIndex = selectedItems2.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));
    
                if (existingIndex > -1) {
                    // 如果已選中，則取消選中
                    item.classList.remove('sortable-selected');
                    selectedItems2.splice(existingIndex, 1);
                } else {
                    // 如果未選中，則添加到選中項目中
                    item.classList.add('sortable-selected');
                    selectedItems2.push({ label, data });
                }
    
                // 更新圖表
                updateChart(selectedItems2);
             });
          });
    
            const sc = document.getElementById('selectionChart').getContext('2d');
            let selectionChart = new Chart(sc, {
                type: 'line',
                data: {
                    labels: [], // Example labels
                    datasets: []
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
    
    
    
    
        function updateChart(selectedData) {
            // Step 1: Collect all unique timestamps from selectedData
            const uniqueLabels = new Set();
            selectedData.forEach(item => {
                let itemLabels;
                try {
                    itemLabels = JSON.parse(item.textContent);
                    itemLabels.forEach(label => uniqueLabels.add(label));
                } catch (e) {
                    console.error("Error parsing textContent for labels:", e);
                }
            });
    
            // Convert Set to sorted array of unique labels (timestamps)
            const sortedLabels = Array.from(uniqueLabels)
                .sort((a, b) => new Date(a) - new Date(b)); // Sort by date
    
            // Step 2: Prepare datasets with data aligned to sortedLabels
            const datasets = selectedData.map(item => {
                let itemLabels, itemData;
    
                try {
                    itemLabels = JSON.parse(item.textContent);
                    itemData = item.data;
                } catch (e) {
                    console.error("Error parsing item data or labels:", e);
                }
    
                // Align data with sortedLabels by placing nulls where timestamps don't match
                const alignedData = sortedLabels.map(label => {
                    const index = itemLabels ? itemLabels.indexOf(label) : -1;
                    return index !== -1 ? itemData[index] : null;
                });
    
                return {
                    label: item.label,
                    data: alignedData,
                    fill: false,
                    borderColor: getRandomColor(),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                };
            });
    
            // Step 3: Update chart with sorted labels and aligned datasets
            selectionChart.data.labels = sortedLabels;  // Set x-axis to all unique timestamps
            selectionChart.data.datasets = datasets;
            selectionChart.update();
        }
    
    
    
    
                // Function to generate random colors for the chart lines
            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
    
            function submitFormWithUpdatedItem(value) {
                    document.getElementById('updated_item').value = value;
                    document.getElementById('updateForm').submit();
                }
    </script>
    <script>
        // 航運數據 (Shipping Data) Buttons - Only one button can be selected at a time
        const shippingButtons = document.querySelectorAll('.btn-group[aria-label="Basic example"] .btn');
        shippingButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deselect all buttons in this group
                shippingButtons.forEach(btn => btn.classList.remove('btn-secondary', 'sortable-selected'));
                // Select the clicked button
                this.classList.add('btn-secondary', 'sortable-selected');
    
                // Trigger the draw chart function with the selected data
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);
            });
        });
    
    </script>
    

    <!-- data 7 -->
    <script>
        function drawChart(df7_value) {
            // Initialize arrays for storing label and value, but store indexArray only once
            const indexArray = [];
            const labelArray = [];
            const valueArray = [];
    
            let indexStored = false;  // Flag to ensure we only store indexArray once
    
            // Retrieve the data passed from the backend
            data_type = df7_value['index'];
            const df7 = {{df7 | safe}}[data_type];
    
            // Traverse through the data object
            for (const key in df7) {
                if (!key.includes('_time')) {
                    // If the key doesn't contain '_time', it's a label
                    const label = key;
                    const values = df7[key];
    
                    // Find the corresponding _time key
                    const timeKey = `${label}_time`;
                    const timeValues = df7[timeKey];
    
                    if (timeValues && !indexStored) {
                        // If _time key is found and indexArray is not yet stored, store it
                        timeValues.forEach(timeValue => indexArray.push(timeValue));
                        indexStored = true;  // Mark indexArray as stored
                    }
    
                    // Store the label and values for charting
                    values.forEach(value => {
                        labelArray.push(label);
                        valueArray.push(value);
                    });
                }
            }

    
            // Get the chart context
            const sc = document.getElementById('shipping_chart').getContext('2d');
    
            // Prepare datasets for each label with corresponding data
            const datasets = [...new Set(labelArray)].map(label => {
                return {
                    label: label,
                    data: valueArray.filter((_, i) => labelArray[i] === label),  // Filter values based on the label
                    fill: false,
                    borderColor: getRandomColor(),
                    tension: 0.1
                };
            });
    
            // Function to generate random colors for each line
            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
    
            // Destroy any existing chart instance before creating a new one
            if (window.shippingChart) {
                window.shippingChart.destroy();
            }
    
            // Create the new chart
            window.shippingChart = new Chart(sc, {
                type: 'line',
                data: {
                    labels: indexArray, // X-axis values (time periods), stored only once
                    datasets: datasets  // Datasets for each label
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }
    
        // Add event listener for button clicks to trigger the chart generation
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function () {
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);  // Call drawChart on button click
            });
        });

            // 定義每個指數的文字解說
        const descriptions = {
            "全球主幹航線綜合準班率指數": "<ol><li><strong>指數目標：</strong><p>衡量班輪服務品質，科學評估班輪公司及其聯盟的航班準班率，推動服務標準化，提升全球供應鏈管理效率。</p></li><li><strong>指數結構：</strong><ul><li>主幹航線準班率指數</li><li>班輪公司及聯盟準班率指數</li><li>港口班輪準班率指數</li></ul></li><li><strong>樣本範圍：</strong><ul><li><strong>航線：</strong> 涵蓋亞洲—歐洲、美洲、大洋洲、非洲等10條全球主幹航線。</li><li><strong>港口：</strong> 50個主要港口及489個常用港口（如上海、鹿特丹、洛杉磯）。</li><li><strong>班輪公司：</strong> 全球運力排名前13的公司及三大班輪聯盟（2M、Ocean、THE）。</li></ul></li><li><strong>數據來源：</strong><ul><li><strong>預計數據（ETA/ETB）：</strong> 由船公司提供。</li><li><strong>實際數據（ATA/ATB）：</strong> 基於AIS船舶實時運行數據。</li></ul></li><li><strong>計算模式：</strong><ul><li><strong>準班率：</strong> 偏差不超過24小時計為準班。<ul><li><strong>VO準班率：</strong> 基於班輪運營人（Vessel Operator）。</li><li><strong>SP準班率：</strong> 收發貨服務準班率，基於單港數據。</li><li><strong>PP準班率：</strong> 到離港服務準班率，基於港對港數據。</li></ul></li><li><strong>綜合準班率：</strong> SP與PP的算術平均值。</li><li><strong>港口服務水平：</strong> 港口準班率 × 掛靠密度 × 100。</li></ul></li><li><strong>時間指標：</strong><ul><li><strong>在港時間：</strong> 從港口等待區域到離開泊位的總時長。</li><li><strong>靠泊時間：</strong> 從泊位靠泊到離開泊位的總時長。</li></ul></li><li><strong>發布形式：</strong><ul><li><strong>頻率：</strong> 每月上旬發布上月數據。</li><li><strong>內容：</strong> 包括主幹航線準班率、班輪公司及聯盟準班率、港口準班率等多項指標。</li></ul></li></ol><p><strong>意義：</strong> GCSP指數為航運、貿易與物流企業提供標準化的服務品質評估工具，助力供應鏈管理與市場決策。</p>",
            "全球主幹航線收發貨準班率指數": "採用單港維度，基於10條樣本航線和50個基本港口數據，將船舶實際靠泊前15日班輪公司對外公布的ETB與ATB作對比，偏差不超過24小時計為收發貨服務準班。收發貨準班率是指收發貨服務準班次數佔總班次的比例，簡稱SP準班率。",
            "全球主幹航線到離港準班率指數": "用港對港配對形式，基於10條樣本航線和500多個常用港口數據，將船舶從啟運港離泊時班輪公司對外公佈的ETB與ATB作對比，偏差不超過24小時計為到離港服務準班。到離港準班率是指到離港服務準班次數占總班次的比例，簡稱PP準班率。",
            "港口班輪準確率:準班率": "採用單港維度，基於10條樣本航線所涉及的區域之間航線和489個常用港口數據，將船舶實際靠泊前15日班輪公司公佈的ETB與ATB作比較，偏差不超過24小時計為港口班輪準班。港口班輪準班率是指班輪準班次數占港口總班次的比例。",
            "港口班輪準確率:掛靠數": "採用單港維度，基於10條樣本航線所涉及的區域之間航線，對樣本港口掛靠次數進行統計。同一港口內多次移泊計作一次靠泊。",
            "港口班輪準確率:班期综合服务水平": "指港口班輪準班率與掛靠密度的乘積，再乘以100。掛靠密度 = 港口掛靠數 / 50個樣本港口總掛靠數。",
            "港口班輪準確率:在港时间(天)": "船舶抵達港口等待區域/引水站（根據GVVMC的AIS數據）至船舶離開泊位之間的總時長。",
            "港口班輪準確率:在泊時間(天)": "船舶抵達泊位（根據GVVMC的AIS數據）至船舶離開泊位之間的總時長。",
            "一帶一路航貿指數": "<ol><li><strong>指數目標：</strong><p>反映“一帶一路”在貿易與交通運輸方面的發展成果，提供決策參考。</p></li><li><strong>主要構成：</strong><ul><li><strong>“一帶一路”貿易額指數：</strong> 包括綜合指數與8個成分指數，涵蓋66個國家。</li><li><strong>“一帶一路”集裝箱海運量指數：</strong> 包括綜合指數、進出口成分指數及細分地區指數。</li><li><strong>“海上絲綢之路”運價指數：</strong> 包括綜合指數、出口運價、進口運價、乾散貨運價及原油運價指數。</li></ul></li><li><strong>數據基礎：</strong><ul><li><strong>基期：</strong> 2015年1月，基期指數為100點。</li><li><strong>數據來源：</strong> 上海航運交易所及其相關指數數據（如CCFI、CICFI）。</li></ul></li><li><strong>指數計算方式：</strong><p>公式：<code>100 × 當期數據 ÷ 基期數據</code>，通過加權統計生成綜合指數。</p></li><li><strong>發布時間：</strong><p>每月最後一週的星期三，節假日順延。</p></li><li><strong>意義：</strong><p>為貿易與運輸市場提供準確、量化的參考，展示“一帶一路”建設的成效，助力政策制定與市場規劃。</p></li></ol>",
            "一帶一路貿易額指數": "<p><strong>分區域指數計算方式：</strong> <code>100 × 當期數據 ÷ 基期數據</code></p><p><strong>綜合指數：</strong> 通過分區域指數加權統計計算。</p><hr><h2>指標與覆蓋範圍</h2><table border='1' cellpadding='8' cellspacing='0'><thead><tr><th>指標</th><th>指標範圍</th></tr></thead><tbody><tr><td><strong>蒙俄</strong></td><td>蒙古、俄羅斯聯邦等2國</td></tr><tr><td><strong>中亞</strong></td><td>哈薩克斯坦、吉爾吉斯斯坦、塔吉克斯坦、烏茲別克斯坦、土庫曼斯坦等5國</td></tr><tr><td><strong>南亞</strong></td><td>印度、巴基斯坦、孟加拉國、阿富汗、尼泊爾聯邦民主共和國、不丹、斯里蘭卡、馬爾代夫等8國</td></tr><tr><td><strong>東南亞</strong></td><td>越南、老撾、柬埔寨、泰國、馬來西亞、新加坡、印度尼西亞、汶萊、菲律賓、緬甸、東帝汶等11國</td></tr><tr><td><strong>西亞</strong></td><td>土耳其、伊朗、敘利亞、伊拉克、阿聯酋、沙特阿拉伯、卡塔爾、巴林、科威特、黎巴嫩、阿曼、也門、約旦、以色列、巴勒斯坦、格魯吉亞、亞美尼亞、阿塞拜疆等18國</td></tr><tr><td><strong>北非</strong></td><td>埃及等1國</td></tr><tr><td><strong>歐洲</strong></td><td>波蘭、捷克、斯洛伐克、匈牙利、愛沙尼亞、拉脫維亞、立陶宛、白俄羅斯、烏克蘭、摩爾多瓦、塞爾維亞、黑山、克羅地亞、斯洛文尼亞、波黑、前南馬其頓、羅馬尼亞、保加利亞、阿爾巴尼亞等19國</td></tr><tr><td><strong>大洋洲</strong></td><td>澳大利亞、新西蘭等2國</td></tr></tbody></table>",
            "集裝箱海運量指數": "<p><strong>分區域指數計算方式：</strong> <code>100 × 當期數據 ÷ 基期數據</code></p><p><strong>綜合指數：</strong> 通過分區域指數加權統計計算。</p><hr><h2>指標與覆蓋範圍</h2><table border='1' cellpadding='8' cellspacing='0'><thead><tr><th>指標</th><th>指標範圍</th></tr></thead><tbody><tr><td><strong>蒙俄</strong></td><td>蒙古、俄羅斯聯邦等2國</td></tr><tr><td><strong>中亞</strong></td><td>哈薩克斯坦、吉爾吉斯斯坦、塔吉克斯坦、烏茲別克斯坦、土庫曼斯坦等5國</td></tr><tr><td><strong>東南亞</strong></td><td>越南、老撾、柬埔寨、泰國、馬來西亞、新加坡、印度尼西亞、汶萊、菲律賓、緬甸、東帝汶等11國</td></tr><tr><td><strong>歐洲</strong></td><td>英國、愛爾蘭、荷蘭、比利時、盧森堡、法國、摩納哥、冰島、法羅群島、丹麥、挪威、瑞典、芬蘭、波蘭、捷克、斯洛伐克、匈牙利、德國、奧地利、瑞士、列支敦士登、愛沙尼亞、拉脫維亞、立陶宛、白俄羅斯、烏克蘭、摩爾多瓦、塞爾維亞、黑山、克羅地亞、斯洛文尼亞、波黑、馬其頓、羅馬尼亞、保加利亞、阿爾巴尼亞、希臘、意大利、梵蒂岡、聖馬力諾、馬耳他、西班牙、葡萄牙、安道爾等44國</td></tr></tbody></table>",
            "海上絲綢之路運價指數": "<p><strong>分區域指數計算方式：</strong><code>100 × 當期數據 ÷ 基期數據</code></p><p><strong>綜合指數：</strong> 通過分區域指數加權統計計算。</p><hr><h2>指標與覆蓋範圍</h2><table border='1' cellpadding='8' cellspacing='0'><thead><tr><th>地區</th><th>指標範圍</th></tr></thead><tbody><tr><td><strong>俄遠東</strong></td><td>俄羅斯海參崴、東方港等2港</td></tr><tr><td><strong>南亞</strong></td><td>印度、巴基斯坦、孟加拉國、阿富汗、尼泊爾聯邦民主共和國、不丹、斯里蘭卡、馬爾代夫等8國</td></tr><tr><td><strong>東南亞</strong></td><td>越南、老撾、柬埔寨、泰國、馬來西亞、新加坡、印度尼西亞、汶萊、菲律賓、緬甸、東帝汶等11國</td></tr><tr><td><strong>西亞</strong></td><td>土耳其、伊朗、敘利亞、伊拉克、阿聯酋、沙特阿拉伯、卡塔爾、巴林、科威特、黎巴嫩、阿曼、也門、約旦、以色列、巴勒斯坦、格魯吉亞、亞美尼亞、阿塞拜疆等18國</td></tr><tr><td><strong>歐洲</strong></td><td>英國、愛爾蘭、荷蘭、比利時、盧森堡、法國、摩納哥、冰島、法羅群島、丹麥、挪威、瑞典、芬蘭、波蘭、捷克、斯洛伐克、匈牙利、德國、奧地利、瑞士、列支敦士登、愛沙尼亞、拉脫維亞、立陶宛、白俄羅斯、烏克蘭、摩爾多瓦、塞爾維亞、黑山、克羅地亞、斯洛文尼亞、波黑、馬其頓、羅馬尼亞、保加利亞、阿爾巴尼亞、希臘、意大利、梵蒂岡、聖馬力諾、馬耳他、西班牙、葡萄牙、安道爾等44國，以及俄羅斯聖彼得堡、新羅西斯克等2港</td></tr><tr><td><strong>大洋洲</strong></td><td>澳大利亞、新西蘭等2國</td></tr><tr><td><strong>北非</strong></td><td>埃及等1國</td></tr></tbody></table>"
        };

    // 監聽按鈕點擊事件
    document.querySelectorAll('.btn-group .btn').forEach(button => {
        button.addEventListener('click', () => {
            // 獲取按鈕的指數名稱
            const indexName = JSON.parse(button.getAttribute('name')).index;

            // 更新解說區內容
            const descriptionDiv = document.getElementById('description');
            descriptionDiv.innerHTML = `<p>${descriptions[indexName]}</p>`;
        });
    });
    </script>
    
    <script>
        // 定義變數來存儲已選的公司和索引資訊
        let selectedCompany = null;
        let selectedIndex = null;
    
        // 切換選擇狀態的函數，允許第二次點擊取消選擇
        function toggleSelection(buttonGroupClass, button, setFunction) {
            // 判斷按鈕是否已選中
            const isSelected = button.classList.contains('btn-secondary');
            
            // 清除該行所有按鈕的選中狀態
            document.querySelectorAll(`.btn-group[aria-label="${buttonGroupClass}"] .btn`).forEach(btn => btn.classList.remove('btn-secondary'));
            
            if (!isSelected) {
                // 如果按鈕尚未選中，則選中並執行設定函數
                button.classList.add('btn-secondary');
                setFunction(button.innerText.toLowerCase());
            } else {
                // 如果按鈕已選中，則取消選中並移除相應的資訊
                setFunction(null);
            }
    
            // 更新圖像
            updateImage();
        }
    
        // 公司 (Company) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Company Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Company Selection', this, setCompany);
            });
        });
    
        // 索引 (Index) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Index Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Index Selection', this, setIndex);
            });
        });
    
        // 設定公司選擇
        function setCompany(company) {
            selectedCompany = company;
        }
    
        // 設定索引選擇
        function setIndex(index) {
            selectedIndex = index;
        }
    
        // 更新圖像的函數，僅在公司和索引都已選擇時觸發
        function updateImage() {
            const imgElement = document.getElementById('dynamicImage');
            
            if (selectedCompany && selectedIndex) {
                // 組合圖像路徑並顯示
                const basePath = "{{ url_for('static', filename='') }}";
                const imgPath = `${basePath}${selectedCompany}_${selectedIndex}.png`;
                imgElement.src = imgPath;
                imgElement.style.display = 'block';
            } else {
                // 隱藏圖像元素
                imgElement.style.display = 'none';
            }
        }
    </script>
    

<!-- data9_1 -->
<script>
    // 儲存已選擇的項目
    let selectedCategory = null;
    let selectedMetal = null;
    let selectedDataType = null;
    let selectedData = [];

    // 初始化金屬類型列表
    function initMetalCategoryList(data) {
        // console.log(data)
        const categoryContent = document.getElementById('metalCategoryContent');
        categoryContent.innerHTML = '';

        Object.keys(data).forEach(category => {
            const item = document.createElement('div');
            item.className = 'item-box';
            item.textContent = category;
            item.addEventListener('click', () => selectCategory(item, category, data[category]));
            categoryContent.appendChild(item);
        });
    }

    // 選擇金屬類型
    function selectCategory(item, category, metals) {
        clearSelection('metalCategoryContent');
        item.classList.add('selected-item');

        selectedCategory = category;
        selectedMetal = null;
        selectedDataType = null;

        const metalNameContent = document.getElementById('metalNameContent');
        metalNameContent.innerHTML = '';

        Object.keys(metals).forEach(metal => {
            const metalItem = document.createElement('div');
            metalItem.className = 'item-box';
            metalItem.textContent = metal;
            metalItem.addEventListener('click', () => selectMetal(metalItem, metal, metals[metal]));
            metalNameContent.appendChild(metalItem);
        });
    }

    // 選擇金屬名稱
    function selectMetal(item, metal, dataTypes) {
        clearSelection('metalNameContent');
        item.classList.add('selected-item');

        selectedMetal = metal;
        selectedDataType = null;

        const dataTypeContent = document.getElementById('metalDataTypeContent');
        dataTypeContent.innerHTML = '';

        Object.keys(dataTypes).forEach(dataType => {
            const dataTypeItem = document.createElement('div');
            dataTypeItem.className = 'item-box';
            dataTypeItem.textContent = dataType;
            // console.log('dataTypes', dataTypes)
            dataTypeItem.addEventListener('click', () => selectDataType(dataTypeItem, dataType, dataTypes[dataType]));
            dataTypeContent.appendChild(dataTypeItem);
        });
    }

    // 選擇數據類型
    function selectDataType(item, dataType, data) {
        clearSelection('metalDataTypeContent');
        item.classList.add('selected-item');

        selectedDataType = dataType;
        selectedData = data;
        // console.log('selectedData', selectedData)

        const dateContent = document.getElementById('metalDateContent');
        dateContent.innerHTML = '';

        // 去重日期列表
        const uniqueDates = Array.from(new Set(data.date || []));

        // 顯示去重後的日期列表
        uniqueDates.forEach((date) => {
            const dateItem = document.createElement('div');
            dateItem.className = 'item-box';
            dateItem.textContent = date;
            dateItem.addEventListener('click', () => selectDate(dateItem, date));
            dateContent.appendChild(dateItem);
        });

        // 默認顯示第一天的數據
        if (uniqueDates.length > 0) {
            selectDate(dateContent.firstChild, uniqueDates[0]);
        }
    }

    // 選擇日期
    function selectDate(item, selectedDate) {
        clearSelection('metalDateContent');
        item.classList.add('selected-item');

        // 根據所選日期篩選數據
        const filteredData = {};

        if (selectedDataType.toLowerCase().endsWith("opening stocks"))  {
            // 處理 "opening stocks" 類型的數據
            const stocks = selectedData.STOCKS || [];
            const amounts = selectedData.AMOUNT || [];
            
            filteredData['AMOUNT'] = amounts.filter((_, index) => selectedData.date[index] === selectedDate);

            // 更新折線圖，X 軸為 STOCKS，Y 軸為 AMOUNT
            updateChart1(stocks, filteredData, 'STOCKS', 'AMOUNT');
        } else {
            // 處理其他數據類型
           // 去重處理
            const filteredContracts = Array.from(selectedData.CONTRACT.filter((_, index) => selectedData.date[index] === selectedDate));
            // console.log(filteredContracts)

            ["BID", "OFFER", "PRICE","Price"].forEach((key) => {
 
                if (Array.isArray(selectedData[key])) {
                    filteredData[key] = selectedData[key].filter((_, index) => selectedData.date[index] === selectedDate);
                }
            });

            // console.log('filteredData:',filteredData)
            // 更新折線圖，X 軸為 CONTRACT
            console.log(filteredContracts)
            updateChart1(filteredContracts, filteredData, 'Contract', 'Value');
        }
    }

    // 更新折線圖
    function updateChart1(xLabels, data, xAxisLabel, yAxisLabel) {
        const chartContext = document.getElementById('metalDataChart').getContext('2d');

        // 使用 Set 去重，並轉為 Array
        const uniqueXLabels = Array.from(new Set(xLabels));

        const datasets = [];
        Object.keys(data).forEach((key) => {
            const alignedData = uniqueXLabels.map((label) => {
                const index = xLabels.indexOf(label);
                return index !== -1 ? parseFloat(data[key][index]) || null : null;
            });

            datasets.push({
                label: key,
                data: alignedData,
                borderColor: getRandomColor(),
                fill: false,
                tension: 0.1,
            });
        });

        if (window.metalDataChartInstance) {
            window.metalDataChartInstance.destroy();
        }

        window.metalDataChartInstance = new Chart(chartContext, {
            type: 'line',
            data: {
                labels: uniqueXLabels,
                datasets: datasets,
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxisLabel,
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisLabel,
                        },
                    },
                },
            },
        });
    }




    // 清除列表中的選中狀態
    function clearSelection(contentId) {
        const content = document.getElementById(contentId);
        const items = content.querySelectorAll('.item-box');
        items.forEach(item => item.classList.remove('selected-item'));
    }



    // 隨機顏色生成
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        initMetalCategoryList({{ df9_1 | safe }});
    });




</script>

<!-- data9_2 -->
<script>
    // 儲存已選擇的項目
    let selectedCategory2 = null;
    let selectedMetal2 = null;
    let selectedDate2 = null;
    let selectedData2 = [];

    // 初始化金屬類型列表
    function initMetalCategoryList2(data) {
        const categoryContent = document.getElementById('metalCategoryContent2');
        categoryContent.innerHTML = '';

        Object.keys(data).forEach(category => {
            const item = document.createElement('div');
            item.className = 'item-box';
            item.textContent = category;
            item.addEventListener('click', () => selectCategory2(item, category, data[category]));
            categoryContent.appendChild(item);
        });
    }

    // 選擇金屬類型
    function selectCategory2(item, category, metals) {
        clearSelection('metalCategoryContent2');
        item.classList.add('selected-item');

        selectedCategory2 = category;
        selectedMetal2 = null;
        selectedDate2 = null;

        const metalNameContent = document.getElementById('metalNameContent2');
        metalNameContent.innerHTML = '';

        Object.keys(metals).forEach(metal => {
            const metalItem = document.createElement('div');
            metalItem.className = 'item-box';
            metalItem.textContent = metal;
            metalItem.addEventListener('click', () => selectMetal2(metalItem, metal, metals[metal]));
            metalNameContent.appendChild(metalItem);
        });
    }

    // 選擇金屬名稱
    function selectMetal2(item, metal, data) {
        clearSelection('metalNameContent2');
        item.classList.add('selected-item');

        selectedMetal2 = metal;
        selectedData2 = data;
        selectedDate2 = null;

        updateDateList(data);
    }

    // 更新日期列表
    function updateDateList(data) {
        const dateContent = document.getElementById('metalDateContent2');
        dateContent.innerHTML = '';

        const uniqueDates = Array.from(new Set(data.date || []));
        uniqueDates.forEach(date => {
            const dateItem = document.createElement('div');
            dateItem.className = 'item-box';
            dateItem.textContent = date;
            dateItem.addEventListener('click', () => selectDate2(dateItem, date));
            dateContent.appendChild(dateItem);
        });

        // 默認顯示第一天的數據
        if (uniqueDates.length > 0) {
            selectDate2(dateContent.firstChild, uniqueDates[0]);
        }
    }

    // 選擇日期
    function selectDate2(item, date) {
        clearSelection('metalDateContent2');
        item.classList.add('selected-item');

        selectedDate2 = date;
        updateVolumeAndEOIChart(selectedData2);
    }

    // 更新折線圖 (交易量與 EOI)
   function updateVolumeAndEOIChart(data) {
    const chartContext = document.getElementById('metalVolumeChart').getContext('2d');

    const contracts = data.CONTRACT || [];
    const volumeData = data.VOLUME || [];
    const eoiData = data.EOI || [];
    const dateData = data.date || [];

    // 根據選擇的日期篩選數據
    const filteredContracts = contracts.filter((_, index) => dateData[index] === selectedDate2);
    const filteredVolumeData = volumeData.filter((_, index) => dateData[index] === selectedDate2);
    const filteredEOIData = eoiData.filter((_, index) => dateData[index] === selectedDate2);

    // 使用 Set 去重，並轉為 Array
    const uniqueContracts = Array.from(new Set(filteredContracts));

    // 對齊數據：根據 uniqueContracts 對齊 Volume 和 EOI
    const alignedVolumeData = uniqueContracts.map(contract => {
        const index = filteredContracts.indexOf(contract);
        return index !== -1 ? filteredVolumeData[index] : null;
    });

    const alignedEOIData = uniqueContracts.map(contract => {
        const index = filteredContracts.indexOf(contract);
        return index !== -1 ? filteredEOIData[index] : null;
    });

    const datasets = [
        {
            label: `交易量 (Volume) - ${selectedDate2}`,
            data: alignedVolumeData.map(value => parseFloat(value) || 0),
            borderColor: 'blue',
            fill: false,
            tension: 0.1,
        },
        {
            label: `EOI (Exchange Open Interest) - ${selectedDate2}`,
            data: alignedEOIData.map(value => parseFloat(value) || 0),
            borderColor: 'red',
            fill: false,
            tension: 0.1,
        }
    ];

    if (window.metalVolumeChartInstance) {
        window.metalVolumeChartInstance.destroy();
    }

    window.metalVolumeChartInstance = new Chart(chartContext, {
        type: 'line',
        data: {
            labels: uniqueContracts,
            datasets: datasets,
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Contract',
                    },
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value',
                    },
                },
            },
        },
    });
}


    // 清除列表中的選中狀態
    function clearSelection(contentId) {
        const content = document.getElementById(contentId);
        const items = content.querySelectorAll('.item-box');
        items.forEach(item => item.classList.remove('selected-item'));
    }

    // 隨機顏色生成
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        initMetalCategoryList2({{ df9_2 | safe }});
    });



</script>

<script>
    // 取得按鈕
    const backToTopButton = document.getElementById("backToTop");

    // 當滾動時觸發
    window.addEventListener("scroll", () => {
        if (window.scrollY > 200) { // 當滾動超過 200px 時顯示按鈕
            backToTopButton.style.display = "block";
        } else {
            backToTopButton.style.display = "none";
        }
    });

    // 點擊按鈕時滑動回頂部
    backToTopButton.addEventListener("click", () => {
        window.scrollTo({
            top: 0,
            behavior: "smooth" // 平滑滾動
        });
    });
</script>

</body>

</html>
