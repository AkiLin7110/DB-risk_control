<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>產品分析</title>
    <style>
        .table-container {
            width: 100%; /* Set a width for the container */
            max-height: 400px; /* Fixed height */
            overflow-y: scroll; /* Vertical scrolling */
            overflow-x: auto; /* Horizontal scrolling if needed */
            border: 1px solid #ddd; /* Optional: border around the table container */
        }

        table.data {
            width: 100%;
            border-collapse: collapse; /* Ensure the borders are collapsed */
        }

        table.data th, table.data td {
            border: 1px solid #ddd; /* Border for the table */
            padding: 8px;
            text-align: left;
        }

        table.data th {
            background-color: #f2f2f2;
            position: sticky; /* Keep header row fixed during vertical scroll */
            top: 0;
        }
        table {
            display: block;
            max-height: 370px;
            overflow: auto;
        }

        .scrollable-container {
        max-height: 400px; /* Adjust this value as needed */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 1px solid #ddd; /* Optional border */
        padding: 10px;
        width: 20%; /* Full width */
        }


        .sortable-selected {
            background-color: #e3e3e3;
            border: 1px solid #000;
        }
        
        /* 設置按鈕容器為 Flex 容器，橫向排列 */
        .button-container {
            display: flex;
            flex-direction: column; /* 預設值，可省略 */
            gap: 10px; /* 按鈕之間的間距 */
            /* 可選擇添加下列屬性來調整對齊方式 */
            /* justify-content: flex-start; */
            /* align-items: center; */
            /* 若按鈕數量過多，可允許換行 */
            flex-wrap: wrap;
        }
        
        /* 整合後的 .item-box 樣式 */
        .item-box {
        border: 1px solid #e3e3e3;
        padding: 1rem;
        width: 100%; /* Full width of the container */
        cursor: pointer;
        margin-bottom: 10px; /* Add some spacing between items */
    }


        /* Additional styling if needed */
        .btn-secondary {
            background-color: #66B3FF;
            color: white;
        }
    </style>
</head>

<body>
    <h2>進出口資料</h2>
    
    <form method='post' action={{ url_for('update_data1') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <!-- 左邊的長條圖 -->
        <div style="width: 50%;">
            <h3>可互換之搪孔或拉孔工具，工具機用</h3>
            <canvas id="myChart"></canvas>
        </div>

        <!-- 右邊的圓餅圖 -->
        <div style="width: 40%;">
            <h3>公司佔台灣出口佔比</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>    

    <h2>各國產品搜索量</h2>
    {% if GEO == "" %}
    <form method="post" action="{{ url_for('update_data2') }}">
        <p>
            <input type="text" name="GEO" placeholder="Enter GEO">
            <input type="submit" name="GEO" value="Submit">
        </p>
    </form>
    {% else %}
        <p>國家:{{ GEO }}</p>
        <div style="height:90%;width:90%;">
            <canvas id="SEOChart"></canvas>
        </div> 
    {% endif %}
    
    <h2>工業生產增加率</h2>
    <form method='post' action={{ url_for('update_data3') }}>
        <p>
        <button type='submit'>更新資料</button>
    </p>
    </form>
    <div style="height:90%;width:90%;">
        <canvas id="chartContainer"></canvas>
    </div> 

    <h2>政府推動計畫名單</h2>
    <input type="text" id="searchInput" placeholder="Search for keywords">
    <div>
        {% for table in tables %}
        {{ table|safe }}
        {% endfor %}
    </div>

    <h2>各國經濟總覽</h2>
    <form method="post" action="{{ url_for('update_data5') }}" id="updateForm">
        <!-- Hidden input to store updated_item -->
        <input type="hidden" name="updated_item" id="updated_item">
    
        <p>
            <!-- Button that triggers JavaScript to set the updated_item value -->
            <button type="button" onclick="submitFormWithUpdatedItem('Overview')">更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <div class="scrollable-container" id="sortable1">
            {% for df5_label in df5_labels %}
            <div class="item-box" data-value = "{{ df5[df5_label] | safe }}" name = "selection_query" value = "{{ df5_label|safe }}"> 
                <!-- {{ df5.df5_label|safe }} -->
                {{ df5_label|safe }}
            </div>
            {% endfor %}
        </div>
        
        
        <div style = "width:70%">
            <canvas id="selectionChart"></canvas>
        </div>
    </div>

    <h2>航運數據</h2>
    <form method='post' action={{ url_for('update_data7') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>
    <div class="btn-group" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線綜合準班率指數"}'>全球主幹航線綜合準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線到離港準班率指數"}'>全球主幹航線到離港準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線收發貨準班率指數"}'>全球主幹航線收發貨準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:準班率"}'>港口班輪準確率:準班率</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:掛靠數"}'>港口班輪準確率:掛靠數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:班期综合服务水平"}'>港口班輪準確率:班期综合服务水平</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在港时间(天)"}'>港口班輪準確率:在港时间(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在泊時間(天)"}'>港口班輪準確率:在泊時間(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路航貿指數"}'>一帶一路航貿指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路貿易額指數"}'>一帶一路貿易額指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "集裝箱海運量指數"}'>集裝箱海運量指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "海上絲綢之路運價指數"}'>海上絲綢之路運價指數</button>
    </div>
    
    <div style = "width:70%">
        <canvas id="shipping_chart"></canvas>
    </div>

    <h2>文字雲</h2>
    <form method='post' action="{{ url_for('update_data8') }}">
        <p>
            <label for="query">Enter Query:</label>
            <input type="text" name="query" id="query">
        </p>
        <p>
            <button type='submit'>更新資料</button>
        </p>
    </form>
    
    <div class="btn-group" role="group" aria-label="Company Selection">
        <button type="button" class="btn btn-primary" onclick="setCompany('fanuc', this)">Fanuc</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('siemens', this)">Siemens</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('syntec', this)">Syntec</button>
    </div>
    
    <div class="btn-group" role="group" aria-label="Index Selection">
        <button type="button" class="btn btn-primary" onclick="setIndex('title', this)">Title</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('subtitle', this)">Subtitle</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('content', this)">Content</button>
    </div>
    
    <!-- Initially hidden image element -->
    <img id="dynamicImage" style="display: none;" alt="公司新註冊商標">




    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const indexs = {{indexs | safe}}
        const label_im = {{ label_im | safe }};  // Ensure the list is safe to use
        // const data_im_indexs = {{ data_im_indexs | safe }};  // Ensure the list is safe to use
        const data_im_values = {{ data_im_values | safe }};  // Ensure the list is safe to use
        const cleaned_data_im_values = data_im_values.map(val => (isNaN(val) ? 0 : val));

        const label_ex = {{ label_ex | safe }};  // Ensure the list is safe to use
        // const data_ex_indexs = {{ data_ex_indexs | safe }};  // Ensure the list is safe to use
        const data_ex_values = {{ data_ex_values | safe }};  // Ensure the list is safe to use

        const chartElement = document.getElementById('myChart');

        new Chart(chartElement, {
            data: {
                labels: indexs,
                datasets: [
                    {
                        type: 'line',
                        label: label_im,
                        data: cleaned_data_im_values,
                        yAxisID: 'y-axis-left',  // First Y-axis
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    },
                    {
                        type: 'line',
                        label: label_ex,
                        data: data_ex_values,
                        yAxisID: 'y-axis-right',  // Second Y-axis
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    }
                ]
            },
            options: {
                scales: {
                    'y-axis-left': {
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            beginAtZero: true
                        }
                    },
                    'y-axis-right': {
                        type: 'linear',
                        position: 'right',
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });
        
    </script>
    
    <script>
        const newchartElement = document.getElementById('pieChart');
        new Chart(newchartElement, {
        type: 'pie',
        data: {
            labels: [
            '伺服電機',
            '控制器',
            '其他'
            ],
            datasets: [{
            label: '營收百分比',
            data: [54, 42, 4], // 需要先把數字轉為百分比
            }]
        },
        options: {
            plugins: {
            tooltip: { // hover
                callbacks: {
                label: function(context) {
                    return ` ${context.parsed} %`; // 想顯示的內容
                }
                }
            }
            }
        }
        });
    </script>

    <!-- data2 -->
    <script>
        const data_indexes = {{data_indexes | safe}}
        const data_controller = {{data_controller | safe}}
        // const data_machine = {{data_machine | safe}}
        const label_2_1 = {{label_2_1 | safe}}
        const label_2_2 = {{label_2_2 | safe}}
        const SEOchartElement = document.getElementById('SEOChart');
        
        if (SEOchartElement) {  // Ensure the canvas element exists
            const context = SEOchartElement.getContext('2d');
            
            if (context) {  // Ensure context is acquired
                new Chart(context, {
                    data: {
                        labels: data_indexes,  // Ensure data_indexes is defined
                        datasets: [
                            {
                                type: 'line',
                                label: label_2_1,  // Ensure label_2_1 is defined
                                data: data_controller,  // Ensure data_controller is defined
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            },
                            // {
                            //     type: 'line',
                            //     label: label_2_2,  // Ensure label_2_2 is defined
                            //     data: data_machine,  // Ensure data_machine is defined
                            //     borderColor: 'green',
                            //     backgroundColor: 'rgba(0, 255, 0, 0.1)',
                            // }
                        ]
                    }
                });
            } else {
                console.error('Failed to acquire context for SEOChart.');
            }
        }
    </script>

    <script>
        const indexs_3 = {{indexs_3 | safe}}
        const label_3 = {{label_3 | safe}}
        const data = {{data | safe}}

        const ctx = document.getElementById('chartContainer').getContext('2d');
        
        // Prepare datasets for each country
        const datasets = label_3.map(country => ({
            label: country,
            data: data[country],
            fill: false,
            borderColor: getRandomColor(),
            tension: 0.1
        }));

        // Function to generate random colors for each line
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Create the chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: indexs_3, // X-axis (e.g., time periods)
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            $("#searchInput").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("table.data tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>

    <!-- data5 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        const sortable1El = document.getElementById('sortable1')
        const sortable1 = Sortable.create(sortable1El, {
            multiDrag: true, // 可以多選
            selectedClass: "sortable-selected", // 多選時的class
            fallbackTolerance: 3, // 在手機版上可以多選
            animation: 150
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const selectedItems = [];
        const itemBoxes = document.querySelectorAll('.item-box');
        
        itemBoxes.forEach(item => {
        item.addEventListener('click', () => {
            // 解析 data-value 屬性的 JSON 數據
            const data = JSON.parse(item.getAttribute('data-value'));
            const label = item.getAttribute('value');

            // 查找是否已經選中
            const existingIndex = selectedItems.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));

            if (existingIndex > -1) {
                // 如果已選中，則取消選中
                item.classList.remove('sortable-selected');
                selectedItems.splice(existingIndex, 1);
            } else {
                // 如果未選中，則添加到選中項目中
                item.classList.add('sortable-selected');
                selectedItems.push({ label, data });
            }
            

            // 更新圖表
            updateChart(selectedItems);
        });
    });

        const sc = document.getElementById('selectionChart').getContext('2d');
        let selectionChart = new Chart(sc, {
            type: 'line',
            data: {
                labels: ['Label 1', 'Label 2', 'Label 3', 'Label 4'], // Example labels
                datasets: []
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });



        function updateChart(selectedData) {
            const datasets = selectedData.map((item) => ({
        label: item.label, // 使用實際的標籤
        data: item.data,
        fill: false,
        borderColor: getRandomColor(),
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
        }));

            selectionChart.data.datasets = datasets;
            selectionChart.update();
        }

        // Function to generate random colors for the chart lines
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
    <script>
        // Function to set updated_item value and submit the form
        function submitFormWithUpdatedItem(value) {
            document.getElementById('updated_item').value = value;
            document.getElementById('updateForm').submit();
        }
    </script>
    <script>
        // 航運數據 (Shipping Data) Buttons - Only one button can be selected at a time
        const shippingButtons = document.querySelectorAll('.btn-group[aria-label="Basic example"] .btn');
        shippingButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deselect all buttons in this group
                shippingButtons.forEach(btn => btn.classList.remove('btn-secondary', 'sortable-selected'));
                // Select the clicked button
                this.classList.add('btn-secondary', 'sortable-selected');
    
                // Trigger the draw chart function with the selected data
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);
            });
        });
    
        // // 文字雲 (Word Cloud) Buttons - Allow multiple selections across rows, only one per row
        // function toggleSelection(buttonGroupClass, button) {
        //     // Deselect all buttons in the same row (or button group)
        //     document.querySelectorAll(`.${buttonGroupClass} .btn`).forEach(btn => btn.classList.remove('btn-secondary'));
        //     // Select the clicked button
        //     button.classList.add('btn-secondary');
        // }
    
        // // Word Cloud Company and Index Buttons
        // document.querySelectorAll('.btn-group[aria-label="Company Selection"] .btn').forEach(button => {
        //     button.addEventListener('click', function() {
        //         toggleSelection('Company Selection', this);
        //         setCompany(this.innerText.toLowerCase());
        //     });
        // });
    
        // document.querySelectorAll('.btn-group[aria-label="Index Selection"] .btn').forEach(button => {
        //     button.addEventListener('click', function() {
        //         toggleSelection('Index Selection', this);
        //         setIndex(this.innerText.toLowerCase());
        //     });
        // });
    </script>
    

    <!-- data 7 -->
    <script>
        function drawChart(df7_value) {
            // Initialize arrays for storing label and value, but store indexArray only once
            const indexArray = [];
            const labelArray = [];
            const valueArray = [];
    
            let indexStored = false;  // Flag to ensure we only store indexArray once
    
            // Retrieve the data passed from the backend
            data_type = df7_value['index'];
            console.log(data_type)
            const df7 = {{df7 | safe}}[data_type];
    
            // Traverse through the data object
            for (const key in df7) {
                if (!key.includes('_time')) {
                    // If the key doesn't contain '_time', it's a label
                    const label = key;
                    const values = df7[key];
    
                    // Find the corresponding _time key
                    const timeKey = `${label}_time`;
                    const timeValues = df7[timeKey];
    
                    if (timeValues && !indexStored) {
                        // If _time key is found and indexArray is not yet stored, store it
                        timeValues.forEach(timeValue => indexArray.push(timeValue));
                        indexStored = true;  // Mark indexArray as stored
                    }
    
                    // Store the label and values for charting
                    values.forEach(value => {
                        labelArray.push(label);
                        valueArray.push(value);
                    });
                }
            }
    
            // Log the arrays to check their structure
            console.log("Index Array: ", indexArray);
            console.log("Label Array: ", labelArray);
            console.log("Value Array: ", valueArray);
    
            // Get the chart context
            const sc = document.getElementById('shipping_chart').getContext('2d');
    
            // Prepare datasets for each label with corresponding data
            const datasets = [...new Set(labelArray)].map(label => {
                return {
                    label: label,
                    data: valueArray.filter((_, i) => labelArray[i] === label),  // Filter values based on the label
                    fill: false,
                    borderColor: getRandomColor(),
                    tension: 0.1
                };
            });
    
            // Function to generate random colors for each line
            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
    
            // Destroy any existing chart instance before creating a new one
            if (window.shippingChart) {
                window.shippingChart.destroy();
            }
    
            // Create the new chart
            window.shippingChart = new Chart(sc, {
                type: 'line',
                data: {
                    labels: indexArray, // X-axis values (time periods), stored only once
                    datasets: datasets  // Datasets for each label
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }
    
        // Add event listener for button clicks to trigger the chart generation
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function () {
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);  // Call drawChart on button click
            });
        });
    </script>
    
    <script>
        // 定義變數來存儲已選的公司和索引資訊
        let selectedCompany = null;
        let selectedIndex = null;
    
        // 切換選擇狀態的函數，允許第二次點擊取消選擇
        function toggleSelection(buttonGroupClass, button, setFunction) {
            // 判斷按鈕是否已選中
            const isSelected = button.classList.contains('btn-secondary');
            
            // 清除該行所有按鈕的選中狀態
            document.querySelectorAll(`.btn-group[aria-label="${buttonGroupClass}"] .btn`).forEach(btn => btn.classList.remove('btn-secondary'));
            
            if (!isSelected) {
                // 如果按鈕尚未選中，則選中並執行設定函數
                button.classList.add('btn-secondary');
                setFunction(button.innerText.toLowerCase());
            } else {
                // 如果按鈕已選中，則取消選中並移除相應的資訊
                setFunction(null);
            }
    
            // 更新圖像
            updateImage();
        }
    
        // 公司 (Company) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Company Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Company Selection', this, setCompany);
            });
        });
    
        // 索引 (Index) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Index Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Index Selection', this, setIndex);
            });
        });
    
        // 設定公司選擇
        function setCompany(company) {
            selectedCompany = company;
        }
    
        // 設定索引選擇
        function setIndex(index) {
            selectedIndex = index;
        }
    
        // 更新圖像的函數，僅在公司和索引都已選擇時觸發
        function updateImage() {
            const imgElement = document.getElementById('dynamicImage');
            
            if (selectedCompany && selectedIndex) {
                // 組合圖像路徑並顯示
                const basePath = "{{ url_for('static', filename='') }}";
                const imgPath = `${basePath}${selectedCompany}_${selectedIndex}.png`;
                imgElement.src = imgPath;
                imgElement.style.display = 'block';
            } else {
                // 隱藏圖像元素
                imgElement.style.display = 'none';
            }
        }
    </script>
    
    

    <!-- <script>
        // Function to create the chart
        function drawChart(data) {
            const ctx = document.getElementById('shipping_chart').getContext('2d');

            // Destroy the existing chart if it exists
            if (window.shippingChart) {
                window.shippingChart.destroy();
            }

            // Create a new chart
            window.shippingChart = new Chart(ctx, {
                type: 'bar', // You can change this to 'line', 'pie', etc.
                data: {
                    labels: ['Label 1', 'Label 2', 'Label 3', 'Label 4'], // Customize labels as per your data
                    datasets: [{
                        label: '航運數據',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Add event listener for button clicks
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function () {
                const data = JSON.parse(this.getAttribute('data-value'));
                drawChart(data);
            });
        });
    </script> -->
    

</body>

</html>
