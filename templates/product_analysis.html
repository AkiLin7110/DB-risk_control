
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <title>產品分析</title>
    <style>
        .table-container {
            width: 100%; /* Set a width for the container */
            max-height: 400px; /* Fixed height */
            overflow-y: scroll; /* Vertical scrolling */
            overflow-x: auto; /* Horizontal scrolling if needed */
            border: 1px solid #ddd; /* Optional: border around the table container */
        }

        table.data {
            width: 100%;
            border-collapse: collapse; /* Ensure the borders are collapsed */
        }

        table.data th, table.data td {
            border: 1px solid #ddd; /* Border for the table */
            padding: 8px;
            text-align: left;
        }

        table.data th {
            background-color: #f2f2f2;
            position: sticky; /* Keep header row fixed during vertical scroll */
            top: 0;
        }
        table {
            display: block;
            max-height: 370px;
            overflow: auto;
        }

        .scrollable-container {
        max-height: 400px; /* Adjust this value as needed */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 1px solid #ddd; /* Optional border */
        padding: 10px;
        width: 20%; /* Full width */
        }


        .sortable-selected {
            background-color: #e3e3e3;
            border: 1px solid #000;
        }
        
        /* 設置按鈕容器為 Flex 容器，橫向排列 */
        .button-container {
            display: flex;
            flex-direction: column; /* 預設值，可省略 */
            gap: 10px; /* 按鈕之間的間距 */
            /* 可選擇添加下列屬性來調整對齊方式 */
            /* justify-content: flex-start; */
            /* align-items: center; */
            /* 若按鈕數量過多，可允許換行 */
            flex-wrap: wrap;
        }
        
        /* 整合後的 .item-box 樣式 */
        .item-box {
        border: 1px solid #e3e3e3;
        padding: 1rem;
        width: 100%; /* Full width of the container */
        cursor: pointer;
        margin-bottom: 10px; /* Add some spacing between items */
    }


        /* Additional styling if needed */
        .btn-secondary {
            background-color: #66B3FF;
            color: white;
        }

        /* 新增選中項目的樣式 */
        .selected-field {
            background-color: #007BFF; /* 藍色背景 */
            color: #FFFFFF; /* 白色文字 */
            border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        .selected-country {
        background-color: #007BFF; /* 藍色背景 */
        color: #FFFFFF; /* 白色文字 */
        border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        .selected-item {
            background-color: #007BFF; /* 藍色背景 */
            color: #FFFFFF; /* 白色文字 */
            border: 1px solid #0056b3; /* 深藍色邊框 */
        }

        /* 標題固定樣式 */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #f2f2f2; /* 淺灰色背景 */
            padding: 10px;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            z-index: 1; /* 保持在列表內容上層 */
        }
        
        /* 按鈕樣式 */
        button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            background-color: #f0f0f0;
            color: #000;
        }

        /* 選取狀態樣式 */
        button.selected {
            background-color: #66B3FF; /* 綠色背景表示已選取 */
            color: #fff; /* 白色文字 */
        }


    </style>
</head>

<body>
    <h2>進出口資料</h2>
    
    <form method='post' action={{ url_for('update_data1') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <!-- 左邊的長條圖 -->
        <div style="width: 50%;">
            <h3>可互換之搪孔或拉孔工具，工具機用</h3>
            <canvas id="myChart"></canvas>
        </div>

        <!-- 右邊的圓餅圖 -->
        <div style="width: 40%;">
            <h3>公司佔台灣出口佔比</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>  
    
    <h2>各國產品搜索量</h2>
    <form method="post" action="{{ url_for('update_data2') }}" id="productVolumeForm">
        <input type="hidden" name="updated_item" id="productUpdatedItem">
        <p>
            <button type="button" onclick="submitProductVolumeUpdate('ProductVolume')">更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <!-- 左側：國家列表 -->
        <div class="scrollable-container" id="productCountryList">
            <h3>國家</h3>
            {% for df2_label in df2_labels %}
            <div class="item-box"
                data-value="{{ df2[df2_label] | safe }}"
                data-key="{{ df2[df2_label].keys() | list }}"
                value="{{ df2_label | safe }}"
                onclick="selectProductCountry(this)">
                {{ df2_label | safe }}
            </div>
            {% endfor %}
        </div>

        <!-- 中間：欄位列表 -->
        <div class="scrollable-container" id="productFieldList">
            <h3>欄位</h3>
        </div>

        <!-- 右側：折線圖 -->
        <div style="width: 70%;">
            <canvas id="productVolumeChart"></canvas>
        </div>
    </div>

    
    <h2>工業生產增加率</h2>
    <form method='post' action={{ url_for('update_data3') }}>
        <p>
        <button type='submit'>更新資料</button>
    </p>
    </form>
    <div style="height:90%;width:90%;">
        <canvas id="chartContainer"></canvas>
    </div> 

    <h2>政府推動計畫名單</h2>
    <form method='post' action={{ url_for('update_data4') }}>
        <p>
        <button type='submit'>更新資料</button>
    </p>
    </form>
    <input type="text" id="searchInput" placeholder="Search for keywords">
    <div>
        {% for table in tables %}
        {{ table|safe }}
        {% endfor %}
    </div>

    <h2>各國經濟總覽</h2>
    <form method="post" action="{{ url_for('update_data5') }}" id="updateForm">
        <!-- Hidden input to store updated_item -->
        <input type="hidden" name="updated_item" id="updated_item">
    
        <p>
            <!-- Button that triggers JavaScript to set the updated_item value -->
            <button type="button" onclick="submitFormWithUpdatedItem('Overview')">更新資料</button>
        </p>
    </form>

    <div style="display: flex; justify-content: space-between;">
        <div class="scrollable-container" id="sortable1">
            <h3>國家</h3>
            {% for df5_label in df5_labels %}
            <div class="item-box" 
                 data-value="{{ df5[df5_label] | safe }}" 
                 data-key="{{ df5[df5_label].keys() | list }}"
                 name="selection_query" 
                 value="{{ df5_label | safe }}" 
                 onclick="transferItem(this)">
                    {{ df5_label | safe }}
            </div>
            {% endfor %}
        </div>

        <div class="scrollable-container" id="sortable2">
            <h3>欄位</h3>
            <!-- Items from sortable1 will appear here -->
        </div>

        <div style="width:70%">
            <canvas id="selectionChart"></canvas>
        </div>
    </div>

    <h2>航運數據</h2>
    <form method='post' action={{ url_for('update_data7') }}>
        <p>
        <button type='submit'>更新資料</button>
        </p>
    </form>
    <div class="btn-group" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線綜合準班率指數"}'>全球主幹航線綜合準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線到離港準班率指數"}'>全球主幹航線到離港準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "全球主幹航線收發貨準班率指數"}'>全球主幹航線收發貨準班率指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:準班率"}'>港口班輪準確率:準班率</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:掛靠數"}'>港口班輪準確率:掛靠數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:班期综合服务水平"}'>港口班輪準確率:班期综合服务水平</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在港时间(天)"}'>港口班輪準確率:在港时间(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "港口班輪準確率:在泊時間(天)"}'>港口班輪準確率:在泊時間(天)</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路航貿指數"}'>一帶一路航貿指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "一帶一路貿易額指數"}'>一帶一路貿易額指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "集裝箱海運量指數"}'>集裝箱海運量指數</button>
        <button type="button" class="btn btn-primary" name ='{"index": "海上絲綢之路運價指數"}'>海上絲綢之路運價指數</button>
    </div>
    
    <div style = "width:70%">
        <canvas id="shipping_chart"></canvas>
    </div>

    <h2>文字雲</h2>
    <form method='post' action="{{ url_for('update_data8') }}">
        <p>
            <label for="query">Enter Query:</label>
            <input type="text" name="query" id="query">
        </p>
        <p>
            <button type='submit'>更新資料</button>
        </p>
    </form>
    
    <div class="btn-group" role="group" aria-label="Company Selection">
        <button type="button" class="btn btn-primary" onclick="setCompany('fanuc', this)">Fanuc</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('siemens', this)">Siemens</button>
        <button type="button" class="btn btn-primary" onclick="setCompany('syntec', this)">Syntec</button>
    </div>
    
    <div class="btn-group" role="group" aria-label="Index Selection">
        <button type="button" class="btn btn-primary" onclick="setIndex('title', this)">Title</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('subtitle', this)">Subtitle</button>
        <button type="button" class="btn btn-primary" onclick="setIndex('content', this)">Content</button>
    </div>
    
    <!-- Initially hidden image element -->
    <img id="dynamicImage" style="display: none;" alt="文字雲">

    <h2>金屬市場數據分析</h2>
    <form method='post' action={{ url_for('update_data9') }}>
        <p>
            <button type='submit'>更新資料</button>
        </p>
    </form>
    
    <h3>價格</h3>
    <div style="display: flex; justify-content: space-between;">
        <!-- 第一欄：金屬類型 -->
        <div class="scrollable-container" id="metalCategoryList">
            <h3 class="sticky-header">金屬類型</h3>
            <div id="metalCategoryContent"></div>
        </div>
    
        <!-- 第二欄：金屬名稱 -->
        <div class="scrollable-container" id="metalNameList">
            <h3 class="sticky-header">金屬名稱</h3>
            <div id="metalNameContent"></div>
        </div>
    
        <!-- 第三欄：數據類型 -->
        <div class="scrollable-container" id="metalDataTypeList">
            <h3 class="sticky-header">數據類型</h3>
            <div id="metalDataTypeContent"></div>
        </div>

        <!-- 第四欄：數據報價日期 -->
        <div class="scrollable-container" id="metalDateList">
            <h3 class="sticky-header">數據報價日期</h3>
            <div id="metalDateContent"></div>
        </div>


        <!-- 折線圖顯示區 -->
        <!-- x軸: 各個contract, y軸: bid, ask, price -->
        <div style="width: 100%">
            <canvas id="metalDataChart"></canvas>
        </div>
    </div>

    <h3>交易量</h3>
    <div style="display: flex; justify-content: space-between;">
        <!-- 第一欄：金屬類型 -->
        <div class="scrollable-container" id="metalCategoryList2">
            <h3 class="sticky-header">金屬類型</h3>
            <div id="metalCategoryContent2"></div>
        </div>

        <!-- 第二欄：金屬名稱 -->
        <div class="scrollable-container" id="metalNameList2">
            <h3 class="sticky-header">金屬名稱</h3>
            <div id="metalNameContent2"></div>
        </div>

        <!-- 第三欄：數據報價日期 -->
        <div class="scrollable-container" id="metalDateList2">
            <h3 class="sticky-header">數據報價日期</h3>
            <div id="metalDateContent2"></div>
        </div>

        <!-- 折線圖顯示區 -->
        <div style="width: 100%">
            <canvas id="metalVolumeChart"></canvas>
        </div>
    </div>

    

    
    

    </div>


    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const indexs = {{indexs | safe}}
        const label_im = {{ label_im | safe }};  // Ensure the list is safe to use
        // const data_im_indexs = {{ data_im_indexs | safe }};  // Ensure the list is safe to use
        const data_im_values = {{ data_im_values | safe }};  // Ensure the list is safe to use
        const cleaned_data_im_values = data_im_values.map(val => (isNaN(val) ? 0 : val));

        const label_ex = {{ label_ex | safe }};  // Ensure the list is safe to use
        // const data_ex_indexs = {{ data_ex_indexs | safe }};  // Ensure the list is safe to use
        const data_ex_values = {{ data_ex_values | safe }};  // Ensure the list is safe to use

        const chartElement = document.getElementById('myChart');

        new Chart(chartElement, {
            data: {
                labels: indexs,
                datasets: [
                    {
                        type: 'line',
                        label: label_im,
                        data: cleaned_data_im_values,
                        yAxisID: 'y-axis-left',  // First Y-axis
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    },
                    {
                        type: 'line',
                        label: label_ex,
                        data: data_ex_values,
                        yAxisID: 'y-axis-right',  // Second Y-axis
                        borderColor: 'green',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                    }
                ]
            },
            options: {
                scales: {
                    'y-axis-left': {
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            beginAtZero: true
                        }
                    },
                    'y-axis-right': {
                        type: 'linear',
                        position: 'right',
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });
        
    </script>
    
    <script>
        const newchartElement = document.getElementById('pieChart');
        new Chart(newchartElement, {
        type: 'pie',
        data: {
            labels: [
            '伺服電機',
            '控制器',
            '其他'
            ],
            datasets: [{
            label: '營收百分比',
            data: [54, 42, 4], // 需要先把數字轉為百分比
            }]
        },
        options: {
            plugins: {
            tooltip: { // hover
                callbacks: {
                label: function(context) {
                    return ` ${context.parsed} %`; // 想顯示的內容
                }
                }
            }
            }
        }
        });
    </script>

    <!-- data2 -->
    <script>
        // 儲存已選擇的國家和欄位資料
        const selectedProductCountries = [];
        const selectedProductFields = [];

        // 選擇國家並顯示對應的欄位
        function selectProductCountry(item) {
            const fieldContainer = document.getElementById('productFieldList');
            let fieldKeys = item.getAttribute('data-key');
            fieldKeys = fieldKeys.replace(/'/g, '"');

            try {
                fieldKeys = JSON.parse(fieldKeys);
            } catch (error) {
                fieldKeys = fieldKeys.split(',');
            }

            const countryLabel = item.getAttribute('value');
            const countryData = item.getAttribute('data-value');
            const existingIndex = selectedProductCountries.findIndex(selected => selected.label === countryLabel && JSON.stringify(selected.data) === JSON.stringify(countryData));

            if (existingIndex > -1) {
                item.classList.remove('selected-country');
                selectedProductCountries.splice(existingIndex, 1);
                removeProductFields(countryLabel);
            } else {
                item.classList.add('selected-country');
                selectedProductCountries.push({ label: countryLabel, data: countryData });
                displayProductFields(fieldKeys, countryLabel);
            }
        }

        // 顯示對應欄位列表
        function displayProductFields(keys, countryLabel) {
            const fieldContainer = document.getElementById('productFieldList');
            const productData = {{ df2 | safe }};

            keys.forEach(key => {
                if (!key.includes('unit') && !key.includes('date')) {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'item-box';
                    fieldItem.textContent = `${countryLabel} - ${key}`;
                    fieldItem.dataset.key = key;
                    fieldItem.dataset.label = countryLabel;
                    fieldItem.dataset.value = JSON.stringify(productData[countryLabel][key]);
                    fieldItem.dataset.dates = JSON.stringify(productData[countryLabel][`${key}_date`]);

                    fieldItem.addEventListener('click', () => {
                        const fieldData = JSON.parse(fieldItem.getAttribute('data-value'));
                        const fieldLabel = `${countryLabel} - ${key}`;
                        const existingIndex = selectedProductFields.findIndex(field => field.label === fieldLabel && JSON.stringify(field.data) === JSON.stringify(fieldData));

                        if (existingIndex > -1) {
                            fieldItem.classList.remove('selected-field');
                            selectedProductFields.splice(existingIndex, 1);
                        } else {
                            fieldItem.classList.add('selected-field');
                            selectedProductFields.push({ label: fieldLabel, data: fieldData, dates: fieldItem.dataset.dates });
                        }

                        updateProductVolumeChart(selectedProductFields);
                    });

                    fieldContainer.appendChild(fieldItem);
                }
            });
        }

        // 移除欄位並更新圖表
        function removeProductFields(countryLabel) {
            const fieldContainer = document.getElementById('productFieldList');
            const fieldsToRemove = fieldContainer.querySelectorAll(`.item-box[data-label='${countryLabel}']`);

            fieldsToRemove.forEach(item => {
                const fieldLabel = `${countryLabel} - ${item.dataset.key}`;
                const existingIndex = selectedProductFields.findIndex(field => field.label === fieldLabel);
                if (existingIndex > -1) {
                    selectedProductFields.splice(existingIndex, 1);
                }
                fieldContainer.removeChild(item);
            });

            updateProductVolumeChart(selectedProductFields);
        }

        // 更新折線圖
        function updateProductVolumeChart(selectedFields) {
        const uniqueDates = new Set();
        selectedFields.forEach(field => {
            let fieldDates;
            try {
                fieldDates = JSON.parse(field.dates);
                fieldDates.forEach(date => uniqueDates.add(date));
            } catch (error) {
                console.error("Error parsing dates:", error);
            }
        });

        const sortedDates = Array.from(uniqueDates).sort((a, b) => new Date(a) - new Date(b));
        const datasets = selectedFields.map(field => {
            let fieldDates, fieldData;
            try {
                fieldDates = JSON.parse(field.dates);
                fieldData = field.data;
            } catch (error) {
                console.error("Error parsing field data:", error);
            }

            const alignedData = sortedDates.map(date => {
                const index = fieldDates ? fieldDates.indexOf(date) : -1;
                return index !== -1 ? fieldData[index] : null;
            });

            return {
                label: field.label,
                data: alignedData,
                fill: false,
                borderColor: getRandomColor(),
                tension: 0.1,
            };
        });

        // 如果圖表已經存在，則只更新資料，不銷毀圖表
        if (window.productVolumeChartInstance) {
            window.productVolumeChartInstance.data.labels = sortedDates;
            window.productVolumeChartInstance.data.datasets = datasets;
            window.productVolumeChartInstance.update(); // 只更新圖表
        } else {
            // 初始化圖表
            const chartContext = document.getElementById('productVolumeChart').getContext('2d');
            window.productVolumeChartInstance = new Chart(chartContext, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Search Volume',
                            },
                        },
                    },
                },
            });
        }
    }


        // 隨機顏色生成
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 提交更新表單
        function submitProductVolumeUpdate(value) {
            document.getElementById('productUpdatedItem').value = value;
            document.getElementById('productVolumeForm').submit();
        }

    </script>

    <!-- data3 -->
    <script>
        const indexs_3 = {{ indexs_3 | safe }};
        const label_3 = {{ label_3 | safe }};
        const data = {{ data | safe }};
        const ctx = document.getElementById('chartContainer').getContext('2d');

        // 隨機顏色生成函數
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 計算移動平均
        function calculateMovingAverage(dataArray, period = 5) {
            const movingAverage = [];
            for (let i = 0; i < dataArray.length; i++) {
                if (i < period - 1) {
                    movingAverage.push(null); // 前幾個數據點無法計算移動平均
                } else {
                    const sum = dataArray.slice(i - period + 1, i + 1).reduce((acc, val) => acc + val, 0);
                    movingAverage.push(sum / period);
                }
            }
            return movingAverage;
        }

        // 準備每個國家的 dataset，包括原始數據和移動平均
        const datasets = label_3.map((country) => {
            const originalData = data[country];
            const movingAverageData = calculateMovingAverage(originalData, 5); // 使用 5 天移動平均
            const color = getRandomColor(); // 為該國家生成隨機顏色

            return [
                {
                    label: `${country} (原始數據)`,
                    data: originalData,
                    fill: false,
                    borderColor: color,
                    tension: 0.1,
                    hidden: true
                },
                {
                    label: `${country} (5 天移動平均)`,
                    data: movingAverageData,
                    fill: false,
                    borderColor: color,
                    borderDash: [2, 2],
                    tension: 0.1,
                    hidden: true
                },
            ];
        }).flat(); // 使用 flat 展開多維數組

        // 繪製圖表
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: indexs_3,
                datasets: datasets,
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period',
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value',
                        },
                    },
                },
            },
        });

    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            $("#searchInput").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("table.data tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>

    <!-- data5 -->
    <script>

        const selectedItems = [];
    
        function transferItem(item) {
            const sortable2 = document.getElementById('sortable2');
            // console.log(sortable2)
            let keys = item.getAttribute('data-key');
            keys = keys.replace(/'/g, '"');
    
            try {
                keys = JSON.parse(keys);
            } catch (e) {
                keys = keys.split(',');
            }
    
            const label = item.getAttribute('value');
            const data = item.getAttribute('data-value');
            
            const existingIndex = selectedItems.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));
    
            if (existingIndex > -1) {
                item.classList.remove('sortable-selected');
                selectedItems.splice(existingIndex, 1);
                removeFieldsFromSortable2(label);
            } else {
                item.classList.add('sortable-selected');
                selectedItems.push({ label, data });
                addFieldsToSortable2(keys, label);
            }
            
        }
    
        function addFieldsToSortable2(keys, label) {
            const sortable2 = document.getElementById('sortable2');
            const df5 = {{df5|safe}}
            
            keys.forEach(key => {
                if (!key.includes('unit') && !key.includes('date')) {
                    const keyItem = document.createElement('div');
                    keyItem.className = 'item-box';
                    keyItem.textContent = `${label} - ${key}`;
                    keyItem.dataset.key = key;
                    keyItem.dataset.label = label;
                    keyItem.dataset.value = JSON.stringify(df5[label][key])
                    keyItem.dataset.textContent = JSON.stringify(df5[label][`${key}_date`])
    
                    // 直接為動態新增的元素綁定點擊事件
                    keyItem.addEventListener('click', () => {
                        const data = JSON.parse(keyItem.getAttribute('data-value'));
                        const itemLabel = `${label} - ${key}`;
                        
                        // 查找是否已經選中
                        const existingIndex = selectedItems2.findIndex(selected => selected.label === itemLabel && JSON.stringify(selected.data) === JSON.stringify(data));
                        
                        if (existingIndex > -1) {
                            keyItem.classList.remove('sortable-selected');
                            selectedItems2.splice(existingIndex, 1);
                        } else {
                            keyItem.classList.add('sortable-selected');
                            selectedItems2.push({ label: itemLabel, data, textContent: keyItem.dataset.textContent });
                        }
                        // console.log(selectedItems2)
                        
                        // 更新圖表
                        updateChart(selectedItems2);
                    });
                    sortable2.appendChild(keyItem);
                }
            });
        }
    
        function removeFieldsFromSortable2(label) {
        const sortable2 = document.getElementById('sortable2');
        const itemsToRemove = sortable2.querySelectorAll(`.item-box[data-label='${label}']`);
    
        itemsToRemove.forEach(item => {
            // 查找並從 selectedItems2 中移除項目
            const existingIndex = selectedItems2.findIndex(selected => selected.label === `${label} - ${item.dataset.key}`);
            if (existingIndex > -1) {
                selectedItems2.splice(existingIndex, 1);
            }
            sortable2.removeChild(item);
        });
        
        // 更新圖表
        updateChart(selectedItems2);
        }
            
        </script>
        
        
    
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const selectedItems2 = [];
            const itemBoxes = document.querySelectorAll('#sortable2 .item-box');
            itemBoxes.forEach(item => {
            item.addEventListener('click', () => {
                // 解析 data-value 屬性的 JSON 數據
                const data = item.getAttribute('data-value');
                const label = item.getAttribute('value');
                // 查找是否已經選中
                const existingIndex = selectedItems2.findIndex(selected => selected.label === label && JSON.stringify(selected.data) === JSON.stringify(data));
    
                if (existingIndex > -1) {
                    // 如果已選中，則取消選中
                    item.classList.remove('sortable-selected');
                    selectedItems2.splice(existingIndex, 1);
                } else {
                    // 如果未選中，則添加到選中項目中
                    item.classList.add('sortable-selected');
                    selectedItems2.push({ label, data });
                }
    
                // 更新圖表
                updateChart(selectedItems2);
             });
          });
    
            const sc = document.getElementById('selectionChart').getContext('2d');
            let selectionChart = new Chart(sc, {
                type: 'line',
                data: {
                    labels: [], // Example labels
                    datasets: []
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
    
    
    
    
        function updateChart(selectedData) {
            // Step 1: Collect all unique timestamps from selectedData
            const uniqueLabels = new Set();
            selectedData.forEach(item => {
                let itemLabels;
                try {
                    itemLabels = JSON.parse(item.textContent);
                    itemLabels.forEach(label => uniqueLabels.add(label));
                } catch (e) {
                    console.error("Error parsing textContent for labels:", e);
                }
            });
    
            // Convert Set to sorted array of unique labels (timestamps)
            const sortedLabels = Array.from(uniqueLabels)
                .sort((a, b) => new Date(a) - new Date(b)); // Sort by date
    
            // Step 2: Prepare datasets with data aligned to sortedLabels
            const datasets = selectedData.map(item => {
                let itemLabels, itemData;
    
                try {
                    itemLabels = JSON.parse(item.textContent);
                    itemData = item.data;
                } catch (e) {
                    console.error("Error parsing item data or labels:", e);
                }
    
                // Align data with sortedLabels by placing nulls where timestamps don't match
                const alignedData = sortedLabels.map(label => {
                    const index = itemLabels ? itemLabels.indexOf(label) : -1;
                    return index !== -1 ? itemData[index] : null;
                });
    
                return {
                    label: item.label,
                    data: alignedData,
                    fill: false,
                    borderColor: getRandomColor(),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                };
            });
    
            // Step 3: Update chart with sorted labels and aligned datasets
            selectionChart.data.labels = sortedLabels;  // Set x-axis to all unique timestamps
            selectionChart.data.datasets = datasets;
            selectionChart.update();
        }
    
    
    
    
                // Function to generate random colors for the chart lines
            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
    
            function submitFormWithUpdatedItem(value) {
                    document.getElementById('updated_item').value = value;
                    document.getElementById('updateForm').submit();
                }
    </script>
    <script>
        // 航運數據 (Shipping Data) Buttons - Only one button can be selected at a time
        const shippingButtons = document.querySelectorAll('.btn-group[aria-label="Basic example"] .btn');
        shippingButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deselect all buttons in this group
                shippingButtons.forEach(btn => btn.classList.remove('btn-secondary', 'sortable-selected'));
                // Select the clicked button
                this.classList.add('btn-secondary', 'sortable-selected');
    
                // Trigger the draw chart function with the selected data
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);
            });
        });
    
    </script>
    

    <!-- data 7 -->
    <script>
        function drawChart(df7_value) {
            // Initialize arrays for storing label and value, but store indexArray only once
            const indexArray = [];
            const labelArray = [];
            const valueArray = [];
    
            let indexStored = false;  // Flag to ensure we only store indexArray once
    
            // Retrieve the data passed from the backend
            data_type = df7_value['index'];
            const df7 = {{df7 | safe}}[data_type];
    
            // Traverse through the data object
            for (const key in df7) {
                if (!key.includes('_time')) {
                    // If the key doesn't contain '_time', it's a label
                    const label = key;
                    const values = df7[key];
    
                    // Find the corresponding _time key
                    const timeKey = `${label}_time`;
                    const timeValues = df7[timeKey];
    
                    if (timeValues && !indexStored) {
                        // If _time key is found and indexArray is not yet stored, store it
                        timeValues.forEach(timeValue => indexArray.push(timeValue));
                        indexStored = true;  // Mark indexArray as stored
                    }
    
                    // Store the label and values for charting
                    values.forEach(value => {
                        labelArray.push(label);
                        valueArray.push(value);
                    });
                }
            }

    
            // Get the chart context
            const sc = document.getElementById('shipping_chart').getContext('2d');
    
            // Prepare datasets for each label with corresponding data
            const datasets = [...new Set(labelArray)].map(label => {
                return {
                    label: label,
                    data: valueArray.filter((_, i) => labelArray[i] === label),  // Filter values based on the label
                    fill: false,
                    borderColor: getRandomColor(),
                    tension: 0.1
                };
            });
    
            // Function to generate random colors for each line
            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
    
            // Destroy any existing chart instance before creating a new one
            if (window.shippingChart) {
                window.shippingChart.destroy();
            }
    
            // Create the new chart
            window.shippingChart = new Chart(sc, {
                type: 'line',
                data: {
                    labels: indexArray, // X-axis values (time periods), stored only once
                    datasets: datasets  // Datasets for each label
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }
    
        // Add event listener for button clicks to trigger the chart generation
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function () {
                const df7_value = JSON.parse(this.getAttribute('name'));
                drawChart(df7_value);  // Call drawChart on button click
            });
        });
    </script>
    
    <script>
        // 定義變數來存儲已選的公司和索引資訊
        let selectedCompany = null;
        let selectedIndex = null;
    
        // 切換選擇狀態的函數，允許第二次點擊取消選擇
        function toggleSelection(buttonGroupClass, button, setFunction) {
            // 判斷按鈕是否已選中
            const isSelected = button.classList.contains('btn-secondary');
            
            // 清除該行所有按鈕的選中狀態
            document.querySelectorAll(`.btn-group[aria-label="${buttonGroupClass}"] .btn`).forEach(btn => btn.classList.remove('btn-secondary'));
            
            if (!isSelected) {
                // 如果按鈕尚未選中，則選中並執行設定函數
                button.classList.add('btn-secondary');
                setFunction(button.innerText.toLowerCase());
            } else {
                // 如果按鈕已選中，則取消選中並移除相應的資訊
                setFunction(null);
            }
    
            // 更新圖像
            updateImage();
        }
    
        // 公司 (Company) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Company Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Company Selection', this, setCompany);
            });
        });
    
        // 索引 (Index) 按鈕群組的事件綁定
        document.querySelectorAll('.btn-group[aria-label="Index Selection"] .btn').forEach(button => {
            button.addEventListener('click', function() {
                toggleSelection('Index Selection', this, setIndex);
            });
        });
    
        // 設定公司選擇
        function setCompany(company) {
            selectedCompany = company;
        }
    
        // 設定索引選擇
        function setIndex(index) {
            selectedIndex = index;
        }
    
        // 更新圖像的函數，僅在公司和索引都已選擇時觸發
        function updateImage() {
            const imgElement = document.getElementById('dynamicImage');
            
            if (selectedCompany && selectedIndex) {
                // 組合圖像路徑並顯示
                const basePath = "{{ url_for('static', filename='') }}";
                const imgPath = `${basePath}${selectedCompany}_${selectedIndex}.png`;
                imgElement.src = imgPath;
                imgElement.style.display = 'block';
            } else {
                // 隱藏圖像元素
                imgElement.style.display = 'none';
            }
        }
    </script>
    

<!-- data9_1 -->
<script>
    // 儲存已選擇的項目
    let selectedCategory = null;
    let selectedMetal = null;
    let selectedDataType = null;
    let selectedData = [];

    // 初始化金屬類型列表
    function initMetalCategoryList(data) {
        // console.log(data)
        const categoryContent = document.getElementById('metalCategoryContent');
        categoryContent.innerHTML = '';

        Object.keys(data).forEach(category => {
            const item = document.createElement('div');
            item.className = 'item-box';
            item.textContent = category;
            item.addEventListener('click', () => selectCategory(item, category, data[category]));
            categoryContent.appendChild(item);
        });
    }

    // 選擇金屬類型
    function selectCategory(item, category, metals) {
        clearSelection('metalCategoryContent');
        item.classList.add('selected-item');

        selectedCategory = category;
        selectedMetal = null;
        selectedDataType = null;

        const metalNameContent = document.getElementById('metalNameContent');
        metalNameContent.innerHTML = '';

        Object.keys(metals).forEach(metal => {
            const metalItem = document.createElement('div');
            metalItem.className = 'item-box';
            metalItem.textContent = metal;
            metalItem.addEventListener('click', () => selectMetal(metalItem, metal, metals[metal]));
            metalNameContent.appendChild(metalItem);
        });
    }

    // 選擇金屬名稱
    function selectMetal(item, metal, dataTypes) {
        clearSelection('metalNameContent');
        item.classList.add('selected-item');

        selectedMetal = metal;
        selectedDataType = null;

        const dataTypeContent = document.getElementById('metalDataTypeContent');
        dataTypeContent.innerHTML = '';

        Object.keys(dataTypes).forEach(dataType => {
            const dataTypeItem = document.createElement('div');
            dataTypeItem.className = 'item-box';
            dataTypeItem.textContent = dataType;
            // console.log('dataTypes', dataTypes)
            dataTypeItem.addEventListener('click', () => selectDataType(dataTypeItem, dataType, dataTypes[dataType]));
            dataTypeContent.appendChild(dataTypeItem);
        });
    }

    // 選擇數據類型
    function selectDataType(item, dataType, data) {
        clearSelection('metalDataTypeContent');
        item.classList.add('selected-item');

        selectedDataType = dataType;
        selectedData = data;
        // console.log('selectedData', selectedData)

        const dateContent = document.getElementById('metalDateContent');
        dateContent.innerHTML = '';

        // 去重日期列表
        const uniqueDates = Array.from(new Set(data.date || []));

        // 顯示去重後的日期列表
        uniqueDates.forEach((date) => {
            const dateItem = document.createElement('div');
            dateItem.className = 'item-box';
            dateItem.textContent = date;
            dateItem.addEventListener('click', () => selectDate(dateItem, date));
            dateContent.appendChild(dateItem);
        });

        // 默認顯示第一天的數據
        if (uniqueDates.length > 0) {
            selectDate(dateContent.firstChild, uniqueDates[0]);
        }
    }

    // 選擇日期
    function selectDate(item, selectedDate) {
        clearSelection('metalDateContent');
        item.classList.add('selected-item');

        // 根據所選日期篩選數據
        const filteredData = {};

        if (selectedDataType.toLowerCase().endsWith("opening stocks"))  {
            // 處理 "opening stocks" 類型的數據
            const stocks = selectedData.STOCKS || [];
            const amounts = selectedData.AMOUNT || [];
            
            filteredData['AMOUNT'] = amounts.filter((_, index) => selectedData.date[index] === selectedDate);

            // 更新折線圖，X 軸為 STOCKS，Y 軸為 AMOUNT
            updateChart1(stocks, filteredData, 'STOCKS', 'AMOUNT');
        } else {
            // 處理其他數據類型
           // 去重處理
            const filteredContracts = Array.from(selectedData.CONTRACT.filter((_, index) => selectedData.date[index] === selectedDate));
            // console.log(filteredContracts)

            ["BID", "OFFER", "PRICE","Price"].forEach((key) => {
 
                if (Array.isArray(selectedData[key])) {
                    filteredData[key] = selectedData[key].filter((_, index) => selectedData.date[index] === selectedDate);
                }
            });

            // console.log('filteredData:',filteredData)
            // 更新折線圖，X 軸為 CONTRACT
            console.log(filteredContracts)
            updateChart1(filteredContracts, filteredData, 'Contract', 'Value');
        }
    }

    // 更新折線圖
    function updateChart1(xLabels, data, xAxisLabel, yAxisLabel) {
        const chartContext = document.getElementById('metalDataChart').getContext('2d');

        // 使用 Set 去重，並轉為 Array
        const uniqueXLabels = Array.from(new Set(xLabels));

        const datasets = [];
        Object.keys(data).forEach((key) => {
            const alignedData = uniqueXLabels.map((label) => {
                const index = xLabels.indexOf(label);
                return index !== -1 ? parseFloat(data[key][index]) || null : null;
            });

            datasets.push({
                label: key,
                data: alignedData,
                borderColor: getRandomColor(),
                fill: false,
                tension: 0.1,
            });
        });

        if (window.metalDataChartInstance) {
            window.metalDataChartInstance.destroy();
        }

        window.metalDataChartInstance = new Chart(chartContext, {
            type: 'line',
            data: {
                labels: uniqueXLabels,
                datasets: datasets,
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxisLabel,
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisLabel,
                        },
                    },
                },
            },
        });
    }




    // 清除列表中的選中狀態
    function clearSelection(contentId) {
        const content = document.getElementById(contentId);
        const items = content.querySelectorAll('.item-box');
        items.forEach(item => item.classList.remove('selected-item'));
    }



    // 隨機顏色生成
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        initMetalCategoryList({{ df9_1 | safe }});
    });




</script>

<!-- data9_2 -->
<script>
    // 儲存已選擇的項目
    let selectedCategory2 = null;
    let selectedMetal2 = null;
    let selectedDate2 = null;
    let selectedData2 = [];

    // 初始化金屬類型列表
    function initMetalCategoryList2(data) {
        const categoryContent = document.getElementById('metalCategoryContent2');
        categoryContent.innerHTML = '';

        Object.keys(data).forEach(category => {
            const item = document.createElement('div');
            item.className = 'item-box';
            item.textContent = category;
            item.addEventListener('click', () => selectCategory2(item, category, data[category]));
            categoryContent.appendChild(item);
        });
    }

    // 選擇金屬類型
    function selectCategory2(item, category, metals) {
        clearSelection('metalCategoryContent2');
        item.classList.add('selected-item');

        selectedCategory2 = category;
        selectedMetal2 = null;
        selectedDate2 = null;

        const metalNameContent = document.getElementById('metalNameContent2');
        metalNameContent.innerHTML = '';

        Object.keys(metals).forEach(metal => {
            const metalItem = document.createElement('div');
            metalItem.className = 'item-box';
            metalItem.textContent = metal;
            metalItem.addEventListener('click', () => selectMetal2(metalItem, metal, metals[metal]));
            metalNameContent.appendChild(metalItem);
        });
    }

    // 選擇金屬名稱
    function selectMetal2(item, metal, data) {
        clearSelection('metalNameContent2');
        item.classList.add('selected-item');

        selectedMetal2 = metal;
        selectedData2 = data;
        selectedDate2 = null;

        updateDateList(data);
    }

    // 更新日期列表
    function updateDateList(data) {
        const dateContent = document.getElementById('metalDateContent2');
        dateContent.innerHTML = '';

        const uniqueDates = Array.from(new Set(data.date || []));
        uniqueDates.forEach(date => {
            const dateItem = document.createElement('div');
            dateItem.className = 'item-box';
            dateItem.textContent = date;
            dateItem.addEventListener('click', () => selectDate2(dateItem, date));
            dateContent.appendChild(dateItem);
        });

        // 默認顯示第一天的數據
        if (uniqueDates.length > 0) {
            selectDate2(dateContent.firstChild, uniqueDates[0]);
        }
    }

    // 選擇日期
    function selectDate2(item, date) {
        clearSelection('metalDateContent2');
        item.classList.add('selected-item');

        selectedDate2 = date;
        updateVolumeAndEOIChart(selectedData2);
    }

    // 更新折線圖 (交易量與 EOI)
   function updateVolumeAndEOIChart(data) {
    const chartContext = document.getElementById('metalVolumeChart').getContext('2d');

    const contracts = data.CONTRACT || [];
    const volumeData = data.VOLUME || [];
    const eoiData = data.EOI || [];
    const dateData = data.date || [];

    // 根據選擇的日期篩選數據
    const filteredContracts = contracts.filter((_, index) => dateData[index] === selectedDate2);
    const filteredVolumeData = volumeData.filter((_, index) => dateData[index] === selectedDate2);
    const filteredEOIData = eoiData.filter((_, index) => dateData[index] === selectedDate2);

    // 使用 Set 去重，並轉為 Array
    const uniqueContracts = Array.from(new Set(filteredContracts));

    // 對齊數據：根據 uniqueContracts 對齊 Volume 和 EOI
    const alignedVolumeData = uniqueContracts.map(contract => {
        const index = filteredContracts.indexOf(contract);
        return index !== -1 ? filteredVolumeData[index] : null;
    });

    const alignedEOIData = uniqueContracts.map(contract => {
        const index = filteredContracts.indexOf(contract);
        return index !== -1 ? filteredEOIData[index] : null;
    });

    const datasets = [
        {
            label: `交易量 (Volume) - ${selectedDate2}`,
            data: alignedVolumeData.map(value => parseFloat(value) || 0),
            borderColor: 'blue',
            fill: false,
            tension: 0.1,
        },
        {
            label: `EOI (Exchange Open Interest) - ${selectedDate2}`,
            data: alignedEOIData.map(value => parseFloat(value) || 0),
            borderColor: 'red',
            fill: false,
            tension: 0.1,
        }
    ];

    if (window.metalVolumeChartInstance) {
        window.metalVolumeChartInstance.destroy();
    }

    window.metalVolumeChartInstance = new Chart(chartContext, {
        type: 'line',
        data: {
            labels: uniqueContracts,
            datasets: datasets,
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Contract',
                    },
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value',
                    },
                },
            },
        },
    });
}


    // 清除列表中的選中狀態
    function clearSelection(contentId) {
        const content = document.getElementById(contentId);
        const items = content.querySelectorAll('.item-box');
        items.forEach(item => item.classList.remove('selected-item'));
    }

    // 隨機顏色生成
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        initMetalCategoryList2({{ df9_2 | safe }});
    });



</script>
 
</body>

</html>
